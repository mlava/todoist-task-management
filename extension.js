var t={568:function(t,e,i){var o,n,a;void 0!==i.g?i.g:window||this.window||this.global,n=[],void 0===(a="function"==typeof(o=function(){var t={},e="iziToast",i=(document.querySelector("body"),!!/Mobi/.test(navigator.userAgent)),o=/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor),n="undefined"!=typeof InstallTrigger,a="ontouchstart"in document.documentElement,s=["bottomRight","bottomLeft","bottomCenter","topRight","topLeft","topCenter","center"],r=568,d={};t.children={};var l={id:null,class:"",title:"",titleColor:"",titleSize:"",titleLineHeight:"",message:"",messageColor:"",messageSize:"",messageLineHeight:"",backgroundColor:"",theme:"light",color:"",icon:"",iconText:"",iconColor:"",iconUrl:null,image:"",imageWidth:50,maxWidth:null,zindex:null,layout:1,balloon:!1,close:!0,closeOnEscape:!1,closeOnClick:!1,displayMode:0,position:"bottomRight",target:"",targetFirst:!0,timeout:5e3,rtl:!1,animateInside:!0,drag:!0,pauseOnHover:!0,resetOnHover:!1,progressBar:!0,progressBarColor:"",progressBarEasing:"linear",overlay:!1,overlayClose:!1,overlayColor:"rgba(0, 0, 0, 0.6)",transitionIn:"fadeInUp",transitionOut:"fadeOut",transitionInMobile:"fadeInUp",transitionOutMobile:"fadeOutDown",buttons:{},inputs:{},onOpening:function(){},onOpened:function(){},onClosing:function(){},onClosed:function(){}};if("remove"in Element.prototype||(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)}),"function"!=typeof window.CustomEvent){var c=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i};c.prototype=window.Event.prototype,window.CustomEvent=c}var p=function(t,e,i){if("[object Object]"===Object.prototype.toString.call(t))for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.call(i,t[o],o,t);else if(t)for(var n=0,a=t.length;n<a;n++)e.call(i,t[n],n,t)},u=function(t,e){var i={};return p(t,function(e,o){i[o]=t[o]}),p(e,function(t,o){i[o]=e[o]}),i},m=function(t){var e=document.createDocumentFragment(),i=document.createElement("div");for(i.innerHTML=t;i.firstChild;)e.appendChild(i.firstChild);return e},h={move:function(t,i,a,s){var r,d=.3,l=180;0!==s&&(t.classList.add(e+"-dragged"),t.style.transform="translateX("+s+"px)",s>0?(r=(l-s)/l)<d&&i.hide(u(a,{transitionOut:"fadeOutRight",transitionOutMobile:"fadeOutRight"}),t,"drag"):(r=(l+s)/l)<d&&i.hide(u(a,{transitionOut:"fadeOutLeft",transitionOutMobile:"fadeOutLeft"}),t,"drag"),t.style.opacity=r,r<d&&((o||n)&&(t.style.left=s+"px"),t.parentNode.style.opacity=d,this.stopMoving(t,null)))},startMoving:function(t,e,i,o){o=o||window.event;var n=a?o.touches[0].clientX:o.clientX,s=t.style.transform.replace("px)",""),r=n-(s=s.replace("translateX(",""));i.transitionIn&&t.classList.remove(i.transitionIn),i.transitionInMobile&&t.classList.remove(i.transitionInMobile),t.style.transition="",a?document.ontouchmove=function(o){o.preventDefault();var n=(o=o||window.event).touches[0].clientX-r;h.move(t,e,i,n)}:document.onmousemove=function(o){o.preventDefault();var n=(o=o||window.event).clientX-r;h.move(t,e,i,n)}},stopMoving:function(t,i){a?document.ontouchmove=function(){}:document.onmousemove=function(){},t.style.opacity="",t.style.transform="",t.classList.contains(e+"-dragged")&&(t.classList.remove(e+"-dragged"),t.style.transition="transform 0.4s ease, opacity 0.4s ease",setTimeout(function(){t.style.transition=""},400))}};return t.setSetting=function(e,i,o){t.children[e][i]=o},t.getSetting=function(e,i){return t.children[e][i]},t.destroy=function(){p(document.querySelectorAll("."+e+"-overlay"),function(t,e){t.remove()}),p(document.querySelectorAll("."+e+"-wrapper"),function(t,e){t.remove()}),p(document.querySelectorAll("."+e),function(t,e){t.remove()}),this.children={},document.removeEventListener(e+"-opened",{},!1),document.removeEventListener(e+"-opening",{},!1),document.removeEventListener(e+"-closing",{},!1),document.removeEventListener(e+"-closed",{},!1),document.removeEventListener("keyup",{},!1),d={}},t.settings=function(e){t.destroy(),d=e,l=u(l,e||{})},p({info:{color:"blue",icon:"ico-info"},success:{color:"green",icon:"ico-success"},warning:{color:"orange",icon:"ico-warning"},error:{color:"red",icon:"ico-error"},question:{color:"yellow",icon:"ico-question"}},function(e,i){t[i]=function(t){var i=u(d,t||{});i=u(e,i||{}),this.show(i)}}),t.progress=function(t,i,o){var n=this,a=i.getAttribute("data-iziToast-ref"),s=u(this.children[a],t||{}),r=i.querySelector("."+e+"-progressbar div");return{start:function(){void 0===s.time.REMAINING&&(i.classList.remove(e+"-reseted"),null!==r&&(r.style.transition="width "+s.timeout+"ms "+s.progressBarEasing,r.style.width="0%"),s.time.START=(new Date).getTime(),s.time.END=s.time.START+s.timeout,s.time.TIMER=setTimeout(function(){clearTimeout(s.time.TIMER),i.classList.contains(e+"-closing")||(n.hide(s,i,"timeout"),"function"==typeof o&&o.apply(n))},s.timeout),n.setSetting(a,"time",s.time))},pause:function(){if(void 0!==s.time.START&&!i.classList.contains(e+"-paused")&&!i.classList.contains(e+"-reseted")){if(i.classList.add(e+"-paused"),s.time.REMAINING=s.time.END-(new Date).getTime(),clearTimeout(s.time.TIMER),n.setSetting(a,"time",s.time),null!==r){var t=window.getComputedStyle(r).getPropertyValue("width");r.style.transition="none",r.style.width=t}"function"==typeof o&&setTimeout(function(){o.apply(n)},10)}},resume:function(){void 0!==s.time.REMAINING?(i.classList.remove(e+"-paused"),null!==r&&(r.style.transition="width "+s.time.REMAINING+"ms "+s.progressBarEasing,r.style.width="0%"),s.time.END=(new Date).getTime()+s.time.REMAINING,s.time.TIMER=setTimeout(function(){clearTimeout(s.time.TIMER),i.classList.contains(e+"-closing")||(n.hide(s,i,"timeout"),"function"==typeof o&&o.apply(n))},s.time.REMAINING),n.setSetting(a,"time",s.time)):this.start()},reset:function(){clearTimeout(s.time.TIMER),delete s.time.REMAINING,n.setSetting(a,"time",s.time),i.classList.add(e+"-reseted"),i.classList.remove(e+"-paused"),null!==r&&(r.style.transition="none",r.style.width="100%"),"function"==typeof o&&setTimeout(function(){o.apply(n)},10)}}},t.hide=function(t,o,n){"object"!=typeof o&&(o=document.querySelector(o));var a=this,s=u(this.children[o.getAttribute("data-iziToast-ref")],t||{});s.closedBy=n||null,delete s.time.REMAINING,o.classList.add(e+"-closing"),function(){var t=document.querySelector("."+e+"-overlay");if(null!==t){var i=t.getAttribute("data-iziToast-ref"),o=(i=i.split(",")).indexOf(String(s.ref));-1!==o&&i.splice(o,1),t.setAttribute("data-iziToast-ref",i.join()),0===i.length&&(t.classList.remove("fadeIn"),t.classList.add("fadeOut"),setTimeout(function(){t.remove()},700))}}(),s.transitionIn&&o.classList.remove(s.transitionIn),s.transitionInMobile&&o.classList.remove(s.transitionInMobile),i||window.innerWidth<=r?s.transitionOutMobile&&o.classList.add(s.transitionOutMobile):s.transitionOut&&o.classList.add(s.transitionOut);var d=o.parentNode.offsetHeight;o.parentNode.style.height=d+"px",o.style.pointerEvents="none",(!i||window.innerWidth>r)&&(o.parentNode.style.transitionDelay="0.2s");try{var l=new CustomEvent(e+"-closing",{detail:s,bubbles:!0,cancelable:!0});document.dispatchEvent(l)}catch(t){console.warn(t)}setTimeout(function(){o.parentNode.style.height="0px",o.parentNode.style.overflow="",setTimeout(function(){delete a.children[s.ref],o.parentNode.remove();try{var t=new CustomEvent(e+"-closed",{detail:s,bubbles:!0,cancelable:!0});document.dispatchEvent(t)}catch(t){console.warn(t)}void 0!==s.onClosed&&s.onClosed.apply(null,[s,o,n])},1e3)},200),void 0!==s.onClosing&&s.onClosing.apply(null,[s,o,n])},t.show=function(o){var n,c=this,g=u(d,o||{});if((g=u(l,g)).time={},null===g.id&&(g.id=(n=g.title+g.message+g.color,btoa(encodeURIComponent(n)).replace(/=/g,""))),1===g.displayMode||"once"==g.displayMode)try{if(document.querySelectorAll("."+e+"#"+g.id).length>0)return!1}catch(t){console.warn("["+e+"] Could not find an element with this selector: #"+g.id+". Try to set an valid id.")}if(2===g.displayMode||"replace"==g.displayMode)try{p(document.querySelectorAll("."+e+"#"+g.id),function(t,e){c.hide(g,t,"replaced")})}catch(t){console.warn("["+e+"] Could not find an element with this selector: #"+g.id+". Try to set an valid id.")}g.ref=(new Date).getTime()+Math.floor(1e7*Math.random()+1),t.children[g.ref]=g;var w,f={body:document.querySelector("body"),overlay:document.createElement("div"),toast:document.createElement("div"),toastBody:document.createElement("div"),toastTexts:document.createElement("div"),toastCapsule:document.createElement("div"),cover:document.createElement("div"),buttons:document.createElement("div"),inputs:document.createElement("div"),icon:g.iconUrl?document.createElement("img"):document.createElement("i"),wrapper:null};f.toast.setAttribute("data-iziToast-ref",g.ref),f.toast.appendChild(f.toastBody),f.toastCapsule.appendChild(f.toast),function(){if(f.toast.classList.add(e),f.toast.classList.add(e+"-opening"),f.toastCapsule.classList.add(e+"-capsule"),f.toastBody.classList.add(e+"-body"),f.toastTexts.classList.add(e+"-texts"),i||window.innerWidth<=r?g.transitionInMobile&&f.toast.classList.add(g.transitionInMobile):g.transitionIn&&f.toast.classList.add(g.transitionIn),g.class){var t=g.class.split(" ");p(t,function(t,e){f.toast.classList.add(t)})}var o;g.id&&(f.toast.id=g.id),g.rtl&&(f.toast.classList.add(e+"-rtl"),f.toast.setAttribute("dir","rtl")),g.layout>1&&f.toast.classList.add(e+"-layout"+g.layout),g.balloon&&f.toast.classList.add(e+"-balloon"),g.maxWidth&&(isNaN(g.maxWidth)?f.toast.style.maxWidth=g.maxWidth:f.toast.style.maxWidth=g.maxWidth+"px"),""===g.theme&&"light"===g.theme||f.toast.classList.add(e+"-theme-"+g.theme),g.color&&("#"==(o=g.color).substring(0,1)||"rgb"==o.substring(0,3)||"hsl"==o.substring(0,3)?f.toast.style.background=g.color:f.toast.classList.add(e+"-color-"+g.color)),g.backgroundColor&&(f.toast.style.background=g.backgroundColor,g.balloon&&(f.toast.style.borderColor=g.backgroundColor))}(),g.image&&(f.cover.classList.add(e+"-cover"),f.cover.style.width=g.imageWidth+"px",function(t){try{return btoa(atob(t))==t}catch(t){return!1}}(g.image.replace(/ /g,""))?f.cover.style.backgroundImage="url(data:image/png;base64,"+g.image.replace(/ /g,"")+")":f.cover.style.backgroundImage="url("+g.image+")",g.rtl?f.toastBody.style.marginRight=g.imageWidth+10+"px":f.toastBody.style.marginLeft=g.imageWidth+10+"px",f.toast.appendChild(f.cover)),g.close?(f.buttonClose=document.createElement("button"),f.buttonClose.type="button",f.buttonClose.classList.add(e+"-close"),f.buttonClose.addEventListener("click",function(t){t.target,c.hide(g,f.toast,"button")}),f.toast.appendChild(f.buttonClose)):g.rtl?f.toast.style.paddingLeft="18px":f.toast.style.paddingRight="18px",g.progressBar&&(f.progressBar=document.createElement("div"),f.progressBarDiv=document.createElement("div"),f.progressBar.classList.add(e+"-progressbar"),f.progressBarDiv.style.background=g.progressBarColor,f.progressBar.appendChild(f.progressBarDiv),f.toast.appendChild(f.progressBar)),g.timeout&&(g.pauseOnHover&&!g.resetOnHover&&(f.toast.addEventListener("mouseenter",function(t){c.progress(g,f.toast).pause()}),f.toast.addEventListener("mouseleave",function(t){c.progress(g,f.toast).resume()})),g.resetOnHover&&(f.toast.addEventListener("mouseenter",function(t){c.progress(g,f.toast).reset()}),f.toast.addEventListener("mouseleave",function(t){c.progress(g,f.toast).start()}))),g.iconUrl?(f.icon.setAttribute("class",e+"-icon"),f.icon.setAttribute("src",g.iconUrl)):g.icon&&(f.icon.setAttribute("class",e+"-icon "+g.icon),g.iconText&&f.icon.appendChild(document.createTextNode(g.iconText)),g.iconColor&&(f.icon.style.color=g.iconColor)),(g.icon||g.iconUrl)&&(g.rtl?f.toastBody.style.paddingRight="33px":f.toastBody.style.paddingLeft="33px",f.toastBody.appendChild(f.icon)),g.title.length>0&&(f.strong=document.createElement("strong"),f.strong.classList.add(e+"-title"),f.strong.appendChild(m(g.title)),f.toastTexts.appendChild(f.strong),g.titleColor&&(f.strong.style.color=g.titleColor),g.titleSize&&(isNaN(g.titleSize)?f.strong.style.fontSize=g.titleSize:f.strong.style.fontSize=g.titleSize+"px"),g.titleLineHeight&&(isNaN(g.titleSize)?f.strong.style.lineHeight=g.titleLineHeight:f.strong.style.lineHeight=g.titleLineHeight+"px")),g.message.length>0&&(f.p=document.createElement("p"),f.p.classList.add(e+"-message"),f.p.appendChild(m(g.message)),f.toastTexts.appendChild(f.p),g.messageColor&&(f.p.style.color=g.messageColor),g.messageSize&&(isNaN(g.titleSize)?f.p.style.fontSize=g.messageSize:f.p.style.fontSize=g.messageSize+"px"),g.messageLineHeight&&(isNaN(g.titleSize)?f.p.style.lineHeight=g.messageLineHeight:f.p.style.lineHeight=g.messageLineHeight+"px")),g.title.length>0&&g.message.length>0&&(g.rtl?f.strong.style.marginLeft="10px":2===g.layout||g.rtl||(f.strong.style.marginRight="10px")),f.toastBody.appendChild(f.toastTexts),g.inputs.length>0&&(f.inputs.classList.add(e+"-inputs"),p(g.inputs,function(t,i){f.inputs.appendChild(m(t[0])),(w=f.inputs.childNodes)[i].classList.add(e+"-inputs-child"),t[3]&&setTimeout(function(){w[i].focus()},300),w[i].addEventListener(t[1],function(e){return(0,t[2])(c,f.toast,this,e)})}),f.toastBody.appendChild(f.inputs)),g.buttons.length>0&&(f.buttons.classList.add(e+"-buttons"),p(g.buttons,function(t,i){f.buttons.appendChild(m(t[0]));var o=f.buttons.childNodes;o[i].classList.add(e+"-buttons-child"),t[2]&&setTimeout(function(){o[i].focus()},300),o[i].addEventListener("click",function(e){return e.preventDefault(),(0,t[1])(c,f.toast,this,e,w)})})),f.toastBody.appendChild(f.buttons),g.message.length>0&&(g.inputs.length>0||g.buttons.length>0)&&(f.p.style.marginBottom="0"),(g.inputs.length>0||g.buttons.length>0)&&(g.rtl?f.toastTexts.style.marginLeft="10px":f.toastTexts.style.marginRight="10px",g.inputs.length>0&&g.buttons.length>0&&(g.rtl?f.inputs.style.marginLeft="8px":f.inputs.style.marginRight="8px")),f.toastCapsule.style.visibility="hidden",setTimeout(function(){var t=f.toast.offsetHeight,e=f.toast.currentStyle||window.getComputedStyle(f.toast),i=e.marginTop;i=i.split("px"),i=parseInt(i[0]);var o=e.marginBottom;o=o.split("px"),o=parseInt(o[0]),f.toastCapsule.style.visibility="",f.toastCapsule.style.height=t+o+i+"px",setTimeout(function(){f.toastCapsule.style.height="auto",g.target&&(f.toastCapsule.style.overflow="visible")},500),g.timeout&&c.progress(g,f.toast).start()},100),function(){var t=g.position;if(g.target)f.wrapper=document.querySelector(g.target),f.wrapper.classList.add(e+"-target"),g.targetFirst?f.wrapper.insertBefore(f.toastCapsule,f.wrapper.firstChild):f.wrapper.appendChild(f.toastCapsule);else{if(-1==s.indexOf(g.position))return void console.warn("["+e+"] Incorrect position.\nIt can be â€º "+s);t=i||window.innerWidth<=r?"bottomLeft"==g.position||"bottomRight"==g.position||"bottomCenter"==g.position?e+"-wrapper-bottomCenter":"topLeft"==g.position||"topRight"==g.position||"topCenter"==g.position?e+"-wrapper-topCenter":e+"-wrapper-center":e+"-wrapper-"+t,f.wrapper=document.querySelector("."+e+"-wrapper."+t),f.wrapper||(f.wrapper=document.createElement("div"),f.wrapper.classList.add(e+"-wrapper"),f.wrapper.classList.add(t),document.body.appendChild(f.wrapper)),"topLeft"==g.position||"topCenter"==g.position||"topRight"==g.position?f.wrapper.insertBefore(f.toastCapsule,f.wrapper.firstChild):f.wrapper.appendChild(f.toastCapsule)}isNaN(g.zindex)?console.warn("["+e+"] Invalid zIndex."):f.wrapper.style.zIndex=g.zindex}(),g.overlay&&(null!==document.querySelector("."+e+"-overlay.fadeIn")?(f.overlay=document.querySelector("."+e+"-overlay"),f.overlay.setAttribute("data-iziToast-ref",f.overlay.getAttribute("data-iziToast-ref")+","+g.ref),isNaN(g.zindex)||null===g.zindex||(f.overlay.style.zIndex=g.zindex-1)):(f.overlay.classList.add(e+"-overlay"),f.overlay.classList.add("fadeIn"),f.overlay.style.background=g.overlayColor,f.overlay.setAttribute("data-iziToast-ref",g.ref),isNaN(g.zindex)||null===g.zindex||(f.overlay.style.zIndex=g.zindex-1),document.querySelector("body").appendChild(f.overlay)),g.overlayClose?(f.overlay.removeEventListener("click",{}),f.overlay.addEventListener("click",function(t){c.hide(g,f.toast,"overlay")})):f.overlay.removeEventListener("click",{})),function(){if(g.animateInside){f.toast.classList.add(e+"-animateInside");var t=[200,100,300];"bounceInLeft"!=g.transitionIn&&"bounceInRight"!=g.transitionIn||(t=[400,200,400]),g.title.length>0&&setTimeout(function(){f.strong.classList.add("slideIn")},t[0]),g.message.length>0&&setTimeout(function(){f.p.classList.add("slideIn")},t[1]),(g.icon||g.iconUrl)&&setTimeout(function(){f.icon.classList.add("revealIn")},t[2]);var i=150;g.buttons.length>0&&f.buttons&&setTimeout(function(){p(f.buttons.childNodes,function(t,e){setTimeout(function(){t.classList.add("revealIn")},i),i+=150})},g.inputs.length>0?150:0),g.inputs.length>0&&f.inputs&&(i=150,p(f.inputs.childNodes,function(t,e){setTimeout(function(){t.classList.add("revealIn")},i),i+=150}))}}(),g.onOpening.apply(null,[g,f.toast]);try{var v=new CustomEvent(e+"-opening",{detail:g,bubbles:!0,cancelable:!0});document.dispatchEvent(v)}catch(t){console.warn(t)}setTimeout(function(){f.toast.classList.remove(e+"-opening"),f.toast.classList.add(e+"-opened");try{var t=new CustomEvent(e+"-opened",{detail:g,bubbles:!0,cancelable:!0});document.dispatchEvent(t)}catch(t){console.warn(t)}g.onOpened.apply(null,[g,f.toast])},1e3),g.drag&&(a?(f.toast.addEventListener("touchstart",function(t){h.startMoving(this,c,g,t)},!1),f.toast.addEventListener("touchend",function(t){h.stopMoving(this,t)},!1)):(f.toast.addEventListener("mousedown",function(t){t.preventDefault(),h.startMoving(this,c,g,t)},!1),f.toast.addEventListener("mouseup",function(t){t.preventDefault(),h.stopMoving(this,t)},!1))),g.closeOnEscape&&document.addEventListener("keyup",function(t){27==(t=t||window.event).keyCode&&c.hide(g,f.toast,"esc")}),g.closeOnClick&&f.toast.addEventListener("click",function(t){c.hide(g,f.toast,"toast")}),c.toast=f.toast},t}())?o.apply(e,n):o)||(t.exports=a)}},e={};function i(o){var n=e[o];if(void 0!==n)return n.exports;var a=e[o]={exports:{}};return t[o].call(a.exports,a,a.exports,i),a.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var o in e)i.o(e,o)&&!i.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var o={};i.d(o,{A:()=>P});var n=i(568),a=i.n(n);let s;var r,d,l,c=void 0;let p;var u,m,h,g,w,f,v,y,k,b,I,T=0,A=15,S=!1,C=!1;const O=t=>{const e=window.roamAlphaAPI.util.generateUID();return Promise.all([window.roamAlphaAPI.createBlock({location:{"parent-uid":t.parentUid,order:t.order},block:{uid:e,string:t.node.text}})].concat((t.node.children||[]).map((t,i)=>O({parentUid:e,order:i,node:t}))))},L=({onSubmit:t,title:e,onClose:i})=>{var o=new Date;const[n,a]=window.React.useState(o),s=window.React.useCallback(e=>{t(e),i()},[a,i]),r=window.React.useCallback(()=>{t(""),i()},[i]);return window.React.createElement(window.Blueprint.Core.Dialog,{isOpen:!0,enforceFocus:!1,onClose:r,title:e},window.React.createElement("div",{className:window.Blueprint.Core.Classes.DIALOG_BODY},window.React.createElement(window.Blueprint.Core.Label,{},window.React.createElement(window.Blueprint.DateTime.DatePicker,{onChange:s,highlightCurrentDay:!0,popoverProps:{minimal:!0,captureDismiss:!0}}))))},P={onload:({extensionAPI:t})=>{const e={tabTitle:"Todoist Task Management",settings:[{id:"ttt-token",name:"Todoist API Token",description:"Your API token from https://todoist.com/app/settings/integrations",action:{type:"input",placeholder:"Add Todoist API token here"}},{id:"ttt-import-header",name:"Roam Research Header",description:"Text Header for Roam Research on import",action:{type:"input",placeholder:"Imported Tasks"}},{id:"ttt-account",name:"Account type",description:"Account type - turn on if subscribed to Todoist Premium",action:{type:"switch"}},{id:"ttt-overdue",name:"Include Overdue",description:"Include tasks that are overdue in Today's tasks",action:{type:"switch"}},{id:"ttt-intermediate",name:"Show Intermediate options",description:"Show more configuration options",action:{type:"switch",onChange:t=>{M(t,1)}}},{id:"ttt-advanced",name:"Show Advanced options (beta)",description:"Show advanced configuration options",action:{type:"switch",onChange:t=>{M(t,2)}}}]},i={tabTitle:"Todoist Task Management",settings:[{id:"ttt-token",name:"Todoist API Token",description:"Your API token from https://todoist.com/app/settings/integrations",action:{type:"input",placeholder:"Add Todoist API token here"}},{id:"ttt-import-header",name:"Roam Research Header",description:"Text Header for Roam Research on import",action:{type:"input",placeholder:"Imported Tasks"}},{id:"ttt-account",name:"Account type",description:"Account type - turn on if subscribed to Todoist Premium",action:{type:"switch"}},{id:"ttt-overdue",name:"Include Overdue",description:"Include tasks that are overdue in Today's tasks",action:{type:"switch"}},{id:"ttt-intermediate",name:"Show Intermediate options",description:"Show more configuration options",action:{type:"switch",onChange:t=>{M(t,1)}}},{id:"ttt-auto",name:"Automatic Download",description:"Import items to the DNP automatically",action:{type:"switch",onChange:t=>{P(t,1)}}},{id:"ttt-auto-time",name:"Automatic Download interval",description:"Frequency in minutes to check for new items",action:{type:"input",placeholder:"15",onChange:t=>{P(t,2)}}},{id:"ttt-completed",name:"Include Completed",description:"Include completed tasks in Today's tasks",action:{type:"switch"}},{id:"ttt-completedStrikethrough",name:"Strikethrough Completed Tasks",description:"Strikethrough task content upon completion",action:{type:"switch"}},{id:"ttt-description",name:"Description",description:"Import item description",action:{type:"switch"}},{id:"ttt-subtasks",name:"Subtasks",description:"Import item subtasks",action:{type:"switch"}},{id:"ttt-comments",name:"Comments",description:"Import item comments",action:{type:"switch"}},{id:"ttt-priority",name:"Priority",description:"Import item priority",action:{type:"switch"}},{id:"ttt-createLink",name:"Link in Created Task",description:"Create a link to the Roam block in newly created Todoist tasks",action:{type:"switch"}},{id:"ttt-advanced",name:"Show Advanced options (beta)",description:"Show advanced configuration options",action:{type:"switch",onChange:t=>{M(t,2)}}}]},o={tabTitle:"Todoist Task Management",settings:[{id:"ttt-token",name:"Todoist API Token",description:"Your API token from https://todoist.com/app/settings/integrations",action:{type:"input",placeholder:"Add Todoist API token here"}},{id:"ttt-import-header",name:"Roam Research Header",description:"Text Header for Roam Research on import",action:{type:"input",placeholder:"Imported Tasks"}},{id:"ttt-account",name:"Account type",description:"Account type - turn on if subscribed to Todoist Premium",action:{type:"switch"}},{id:"ttt-overdue",name:"Include Overdue",description:"Include tasks that are overdue in Today's tasks",action:{type:"switch"}},{id:"ttt-intermediate",name:"Show Intermediate options",description:"Show more configuration options",action:{type:"switch",onChange:t=>{M(t,1)}}},{id:"ttt-auto",name:"Automatic Download",description:"Import items to the DNP automatically",action:{type:"switch",onChange:t=>{P(t,1)}}},{id:"ttt-auto-time",name:"Automatic Download interval",description:"Frequency in minutes to check for new items",action:{type:"input",placeholder:"15",onChange:t=>{P(t,2)}}},{id:"ttt-completed",name:"Include Completed",description:"Include completed tasks in Today's tasks",action:{type:"switch"}},{id:"ttt-completedStrikethrough",name:"Strikethrough Completed Tasks",description:"Strikethrough task content upon completion",action:{type:"switch"}},{id:"ttt-description",name:"Description",description:"Import item description",action:{type:"switch"}},{id:"ttt-subtasks",name:"Subtasks",description:"Import item subtasks",action:{type:"switch"}},{id:"ttt-comments",name:"Comments",description:"Import item comments",action:{type:"switch"}},{id:"ttt-priority",name:"Priority",description:"Import item priority",action:{type:"switch"}},{id:"ttt-createLink",name:"Link in Created Task",description:"Create a link to the Roam block in newly created Todoist tasks",action:{type:"switch"}},{id:"ttt-advanced",name:"Show Advanced options (beta)",description:"Show advanced configuration options",action:{type:"switch",onChange:t=>{M(t,2)}}},{id:"ttt-advChildFeat",name:"Advanced Sync features (beta)",description:"Turn on to automatically create tasks, subtasks and comments from within Roam Research",action:{type:"switch",onChange:t=>{D(t)}}}]},n={tabTitle:"Todoist Task Management",settings:[{id:"ttt-token",name:"Todoist API Token",description:"Your API token from https://todoist.com/app/settings/integrations",action:{type:"input",placeholder:"Add Todoist API token here"}},{id:"ttt-import-header",name:"Roam Research Header",description:"Text Header for Roam Research on import",action:{type:"input",placeholder:"Imported Tasks"}},{id:"ttt-account",name:"Account type",description:"Account type - turn on if subscribed to Todoist Premium",action:{type:"switch"}},{id:"ttt-overdue",name:"Include Overdue",description:"Include tasks that are overdue in Today's tasks",action:{type:"switch"}},{id:"ttt-intermediate",name:"Show Intermediate options",description:"Show more configuration options",action:{type:"switch",onChange:t=>{M(t,1)}}},{id:"ttt-advanced",name:"Show Advanced options (beta)",description:"Show advanced configuration options",action:{type:"switch",onChange:t=>{M(t,2)}}},{id:"ttt-advChildFeat",name:"Advanced Sync features (beta)",description:"Turn on to automatically create tasks, subtasks and comments from within Roam Research",action:{type:"switch",onChange:t=>{D(t)}}}]};t.settings.get("ttt-intermediate")?t.settings.get("ttt-advanced")?t.settings.panel.create(o):t.settings.panel.create(i):t.settings.get("ttt-advanced")?t.settings.panel.create(n):t.settings.panel.create(e),t.ui.commandPalette.addCommand({label:"Import tasks from Todoist",callback:()=>{const t=window.roamAlphaAPI.ui.getFocusedBlock()?.["block-uid"];R(!1,!1).then(async e=>{if(null==t){if(p=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid(),null==p){var i=window.location.href;if(/^https:\/\/roamresearch.com\/.+\/(app|offline)\/\w+$/.test(i)){var o=new Date,n=String(o.getDate()).padStart(2,"0"),a=String(o.getMonth()+1).padStart(2,"0"),s=o.getFullYear();p=a+"-"+n+"-"+s}}var r=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":p,order:0},block:{string:u.toString(),uid:r}}),p=r,e.forEach((t,e)=>O({parentUid:p,order:e,node:t}))}else p=t,await window.roamAlphaAPI.updateBlock({block:{uid:p,string:u.toString(),open:!0}}),null!=e&&e.forEach((t,e)=>O({parentUid:p,order:e,node:t}))})}});const a={text:"IMPORTTODOIST",help:"Import tasks from Todoist",handler:t=>z};async function P(t,e){1==e?t.target.checked?(S=!0,H()):(S=!1,clearInterval(T)):2==e&&(""!=t.target.value?(clearInterval(T),A=parseInt(t.target.value),1==S&&H()):clearInterval(T))}async function D(t){C=!!t.target.checked}async function M(a,s){1==s?a.target.checked?t.settings.get("ttt-advanced")?t.settings.panel.create(o):t.settings.panel.create(i):t.settings.get("ttt-advanced")?t.settings.panel.create(n):t.settings.panel.create(e):2==s&&(a.target.checked?t.settings.get("ttt-intermediate")?t.settings.panel.create(o):t.settings.panel.create(n):t.settings.get("ttt-intermediate")?t.settings.panel.create(i):t.settings.panel.create(e))}async function B(){d=document.getElementsByClassName("roam-main")[0],l=document.getElementById("right-sidebar"),c={attributes:!1,childList:!0,subtree:!0},(r=new MutationObserver(function(t,e){for(const c of t)if(1==c.addedNodes[0]?.childNodes[0]?.childNodes[0]?.control?.checked){if(c.addedNodes[0]?.innerHTML?.includes("https://app.todoist.com/app/task")){e.disconnect();var i=c.addedNodes[0]?.innerText?.trim();i=i.split(" Link")[0];var o=c.addedNodes[0]?.innerHTML.split('href="'),n=o[1].split('"');o=n[0];var a=c.addedNodes[0]?.innerHTML?.split("task/"),s=/^(\d{9,10})/gm,r=a[1].match(s),d=c.target?.id?.slice(-9);F(r,i,d,o)}}else if(0==c.addedNodes[0]?.childNodes[0]?.childNodes[0]?.control?.checked&&c.addedNodes[0]?.innerHTML?.includes("https://app.todoist.com/app/task")){e.disconnect(),i=c.addedNodes[0]?.innerText?.trim(),i=i.split(" Link")[0],o=c.addedNodes[0]?.innerHTML.split('href="'),n=o[1].split('"'),o=n[0],a=c.addedNodes[0]?.innerHTML?.split("task/"),s=/^(\d{9,10})/gm;var l=a[1].match(s);d=c.target?.id.slice(-9),U(l,i,d,o)}})).observe(d,c),r.observe(l,c)}async function R(e,i){if(t.settings.get("ttt-token")){const C=t.settings.get("ttt-token");u=t.settings.get("ttt-import-header")?t.settings.get("ttt-import-header"):"Imported tasks",m=t.settings.get("ttt-overdue"),h=t.settings.get("ttt-completed"),v=t.settings.get("ttt-priority"),y=t.settings.get("ttt-description"),k=t.settings.get("ttt-comments"),b=t.settings.get("ttt-subtasks"),f=t.settings.get("ttt-account")?"Premium":"Free";var o,n="projectID: ",a=!1;if(1==e){var s,r=new Date,d=String(r.getDate()).padStart(2,"0"),l=String(r.getMonth()+1).padStart(2,"0"),c=r.getFullYear();g=l+"-"+d+"-"+c;let t=await window.roamAlphaAPI.q(`[:find ?u ?s :where [?b :block/page ?p] [?b :block/uid ?u] [?b :block/order ?s] [?b :block/string "${u}"] [?p :block/uid "${g}"]]`);if(null!=t&&t.length>1){let e,i=999;for(var p=0;p<t.length;p++)parseInt(t[p][1])<i?(i=parseInt(t[p][1]),e&&await window.roamAlphaAPI.deleteBlock({block:{uid:e}}),e=t[p][0].toString()):parseInt(t[p][1])>i&&await window.roamAlphaAPI.deleteBlock({block:{uid:t[p][0]}});s=e}else null!=t&&1==t.length&&(s=t[0][0].toString());if(null==s){const t=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":g,order:9999},block:{string:u,uid:t}}),s=t}o=g}else{var w=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid();if(!w){var T=window.location.href;const t=/^https:\/\/roamresearch.com\/#\/(app|offline)\/\w+$/;document.getElementById("rm-log-container")&&(r=new Date,d=String(r.getDate()).padStart(2,"0"),w=(l=String(r.getMonth()+1).padStart(2,"0"))+"-"+d+"-"+(c=r.getFullYear()),a=!0),t.test(T)&&(r=new Date,d=String(r.getDate()).padStart(2,"0"),w=(l=String(r.getMonth()+1).padStart(2,"0"))+"-"+d+"-"+(c=r.getFullYear()),a=!0)}let t=`[:find (pull ?page [:node/title :block/string :block/uid {:block/children ...} ]) :where [?page :block/uid "${w}"]  ]`;var A=await window.roamAlphaAPI.q(t);if(A.length>0){var S;if(A[0][0].hasOwnProperty("children"))for(p=0;p<A[0][0]?.children.length;p++)A[0][0].children[p].string.match(n)&&(S=A[0][0].children[p].string.split(n));o=A[0][0].uid}}return I=t.settings.get("ttt-completedStrikethrough"),q(C,u,m,v,y,S,a,o,e,s,i,h,I)}E("API")}function z(){return R(!1,!0)}async function H(){console.info("setting automatic download"),/^\d{1,2}$/.test(t.settings.get("ttt-auto-time"))&&(A=parseInt(t.settings.get("ttt-auto-time"))),await R(S);try{T>0&&clearInterval(T)}catch(t){}T=setInterval(async()=>{await R(S)},6e4*A)}async function j(e){var i;r.disconnect();const o=t.settings.get("ttt-token");i=t.settings.get("ttt-import-header")?t.settings.get("ttt-import-header"):"Imported tasks";let n=[],a=await roamAlphaAPI.ui.individualMultiselect.getSelectedUids();if(0===a.length){var s;if(e?(s=e["block-uid"].toString(),l=e["block-string"].toString()):(s=await(window.roamAlphaAPI.ui.getFocusedBlock()?.["block-uid"]),l=await window.roamAlphaAPI.data.pull("[:block/string]",[":block/uid",startBlock])),!l.includes("Task?id="))return void alert("You can't reschedule blocks without a Todoist task");n.push({uid:s,text:l})}else for(var d=0;d<a.length;d++){var l;if((l=(I=await window.roamAlphaAPI.data.pull("[:block/string]",[":block/uid",a[d]]))[":block/string"]).includes("Task?id=")){let t=a[d].toString();n.push({uid:t,text:l})}}if(n.length>0){const t=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid();var c=await(({title:t})=>new Promise(e=>{const i=document.getElementById("app"),o=document.createElement("div");o.id="todoist-prompt-root",i.parentElement.appendChild(o),window.ReactDOM.render(window.React.createElement(L,{onSubmit:e,title:t,onClose:()=>{window.ReactDOM.unmountComponentAtNode(o),o.remove()}}),o)}))({title:"To which date?"});if(c.length<1)return;let e=c.getFullYear();var p=String(c.getDate()).padStart(2,"0"),u=String(c.getMonth()+1).padStart(2,"0");let s=u+"-"+p+"-"+e;var m=function(t){var e=t.split("-"),i=e[2],o=["January","February","March","April","May","June","July","August","September","October","November","December"][Number(e[0])-1],n=Number(e[1]);return o+" "+n+(n>=4&&n<=20||n>=24&&n<=30?"th":["st","nd","rd"][n%10-1])+", "+i}(s),h=await window.roamAlphaAPI.q(`[:find (pull ?e [:node/title]) :where [?e :block/uid "${s}"]]`);h.length>0&&null!=h[0][0]||await window.roamAlphaAPI.createPage({page:{title:m,uid:s}});var g='{"due_date": "'+e+"-"+u+"-"+p+'"}';console.info("Rescheduling task(s) in Todoist");var w=new Headers,f="Bearer "+o;w.append("Authorization",f),w.append("Content-Type","application/json");for(var v={method:"POST",headers:w,body:g},y=0;y<n.length;y++){var k=n[y].text.slice(-11),b="https://api.todoist.com/rest/v2/tasks/"+(k=k.slice(0,10));if((await fetch(b,v)).ok){var I,T=await(window.roamAlphaAPI.q(`[:find ?u :where [?b :block/page ?p] [?b :block/uid ?u] [?b :block/string "${i}"] [?p :block/uid "${s}"]]`)?.[0]?.[0]);if(null==T){const t=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":s,order:0},block:{string:i.toString(),uid:t}}),T=t}if(await window.roamAlphaAPI.moveBlock({location:{"parent-uid":T,order:y},block:{uid:n[y].uid.toString()}}),(I=await window.roamAlphaAPI.q(`[:find (pull ?page [:node/title :block/string :block/uid {:block/children ...} ]) :where [?page :block/uid "${t}"] ]`))[0][0].hasOwnProperty("children")&&I[0][0].children.length>0)for(d=0;d<I[0][0].children.length;d++)if(I[0][0].children[d].string==i){var A=I[0][0]?.children[d]?.uid;I[0][0]?.children[d].hasOwnProperty("children")||await window.roamAlphaAPI.deleteBlock({block:{uid:A}})}}else alert("Failed to reschedule task in Todoist")}0!==a.length&&(window.dispatchEvent(new KeyboardEvent("keydown",{key:"m",keyCode:77,code:"KeyM",which:77,shiftKey:!1,ctrlKey:!0,metaKey:!1})),window.dispatchEvent(new KeyboardEvent("keyup",{key:"m",keyCode:77,code:"KeyM",which:77,shiftKey:!1,ctrlKey:!0,metaKey:!1})))}B()}async function _(e,i,o,n){if(t.settings.get("ttt-token")){const b=t.settings.get("ttt-token"),I=t.settings.get("ttt-createLink");null!=n&&null!=n||(n=await(window.roamAlphaAPI.ui.getFocusedBlock()?.["block-uid"]))||alert("Your cursor must be within a block to create as a task in Todoist");let T=`[:find (pull ?page\n                        [:node/title :block/string :block/uid :children/view-type\n                         :block/order {:block/children ...} {:block/parents ...}\n                        ])\n                     :where [?page :block/uid "${n}"]  ]`;var a,s=await window.roamAlphaAPI.q(T),p="projectID: ";const A=/^\{\{\[\[TODO\]\]\}\}.+$/;if(null!=e){if(e.includes("{{[[TODO]]}}"))var u='{"content": "'+(k=e.split("{{[[TODO]]}}"))[1].trim()+'"';else u='{"content": "'+e+'"';null!=o&&(u+=', "parent_id": "'+o+'"')}else u=A.test(s[0][0].string)?'{"content": "'+s[0][0].string.split("{{[[TODO]]}}")[1]+'"':'{"content": "'+s[0][0].string+'"';const S=/^\d{2}-\d{2}-\d{4}$/;var m=window.location.href;if(S.test(s[0]?.[0]?.parents[0]?.uid)){var h=s[0][0].parents[0].uid.split("-");I&&(u+=', "description": "'+m+"/page/"+n+'"'),u+=', "due_date": "'+h[2]+"-"+h[0]+"-"+h[1]+'"}'}else if(s[0][0].parents[0].hasOwnProperty("children")){I&&(u+=', "description": "'+window.location.href.slice(0,-9)+n+'"');for(var g=0;g<s[0][0].parents[0]?.children.length;g++)s[0][0].parents[0].children[g].string.match(p)&&(a=s[0][0].parents[0].children[g].string.split(p)[1]);u+=null!=a?', "project_id": "'+a+'"}':"}"}var w=new Headers,f="Bearer "+b;w.append("Authorization",f),w.append("Content-Type","application/json");var v={method:"POST",headers:w,body:u};const C=await fetch("https://api.todoist.com/rest/v2/tasks",v),O=await C.text();var y=JSON.parse(O),k="";k+="{{[[TODO]]}} ",k+=""+y.content,k+=" [Link]("+y.url+")",null!=i?(r.disconnect(),await window.roamAlphaAPI.updateBlock({block:{uid:i,string:k.toString()}}),await x(100),r.observe(d,c),r.observe(l,c)):await window.roamAlphaAPI.updateBlock({block:{uid:n,string:k.toString()}})}else E("API")}async function F(e,i,o,n){const a=t.settings.get("ttt-token");I=t.settings.get("ttt-completedStrikethrough");var s=new Headers,r="Bearer "+a;s.append("Authorization",r);var d={method:"POST",headers:s,redirect:"follow"},l="https://api.todoist.com/rest/v2/tasks/"+e+"/close";if((await fetch(l,d)).ok){var c="{{[[DONE]]}} ";I&&(c+="~~"),c+=i.trim()+" [Link]("+n+")",I&&(c+="~~"),await window.roamAlphaAPI.updateBlock({block:{uid:o,string:c.toString(),open:!1}}),console.log("Task Completed in Todoist")}else alert("Failed to complete task in Todoist");await x(50),B()}async function U(e,i,o,n){const a=t.settings.get("ttt-token");var s=new Headers,r="Bearer "+a;s.append("Authorization",r);var d={method:"GET",headers:s,redirect:"follow"},l="https://api.todoist.com/rest/v2/tasks/"+e+"/";const c=await fetch(l,d);var p=await c.text();if(1==JSON.parse(p).due.is_recurring){alert("You can't un-complete a recurring task!");var u="{{[[DONE]]}} ~~"+i.trim()+" [Link]("+n+")~~";await window.roamAlphaAPI.updateBlock({block:{uid:o,string:u.toString(),open:!0}}),await x(50),B()}else{var m={method:"POST",headers:s,redirect:"follow"},h="https://api.todoist.com/rest/v2/tasks/"+e+"/reopen";(await fetch(h,m)).ok?(u="{{[[TODO]]}} "+i.trim(),u+=" [Link]("+n+")",await window.roamAlphaAPI.updateBlock({block:{uid:o,string:u.toString(),open:!0}}),console.log("Task reopened in Todoist")):alert("Failed to reopen task in Todoist"),await x(50),B()}}async function q(e,i,o,n,a,s,r,d,l,c,u,m,h){var g,v,y,I=!1;if(/^\d{2}-\d{2}-\d{4}$/.test(d)){var T=d.split("-"),A=T[2]+"-"+T[0]+"-"+T[1];I=!0}if(r||l)lt=1==o?"https://api.todoist.com/rest/v2/tasks?filter=Today|Overdue":"https://api.todoist.com/rest/v2/tasks?filter=Today";else if(s)lt=Array.isArray(s)?"https://api.todoist.com/rest/v2/tasks?project_id="+s[1].toString():"https://api.todoist.com/rest/v2/tasks?project_id="+s.toString();else if(I){var S=new Date,L=String(S.getDate()).padStart(2,"0"),P=String(S.getMonth()+1).padStart(2,"0"),E=S.getFullYear();lt=d!=(S=P+"-"+L+"-"+E)?"https://api.todoist.com/rest/v2/tasks?filter="+A:1==o?"https://api.todoist.com/rest/v2/tasks?filter=Today|Overdue":"https://api.todoist.com/rest/v2/tasks?filter=Today"}t.settings.get("ttt:tasks")&&(v=JSON.parse(t.settings.get("ttt:tasks")),t.settings.set("ttt:tasks-lastsync",t.settings.get("ttt:tasks")),t.settings.set("ttt:tasks-lastsync:time",Date.now())),t.settings.get("ttt:comments")&&(y=JSON.parse(t.settings.get("ttt:comments")),t.settings.set("ttt:comments-lastsync",t.settings.get("ttt:comments"))),w=await window.roamAlphaAPI.q(`[:find (pull ?page [:node/title :block/string :block/uid :block/order :edit/time {:block/children ...} ]) :where [?page :block/uid "${c}"] ]`);var x=new Headers,N="Bearer "+e;if(x.append("Authorization",N),x.append("Content-Type","application/json"),C&&new Date(t.settings.get("ttt:tasks:time")).getDate()==new Date(t.settings.get("ttt:tasks-lastsync:time")).getDate()&&null!=w&&null!=w&&w?.[0]?.[0]?.hasOwnProperty("children"))for(var D=0;D<w[0][0].children.length;D++){const t=/showTask\?id=([0-9]{9,10})/;let e;if(t.test(w[0][0].children[D].string)&&(e=w[0][0].children[D].string.match(t)[1]),null==e||null==e)await _(w[0][0].children[D].string.toString(),w[0][0].children[D].uid,null,w[0][0].children[D].uid);else{let t=w[0][0].children[D].string.trim().split("[Link]")[0].split("{{[[TODO]]}}"),i=t[1];t[1]&&t[1].match("#Priority")&&(i=t[1].split("#Priority")[0].trim());for(var M=0;M<v.length;M++)if(e==v[M].id&&i!=v[M].content){var B="https://api.todoist.com/rest/v2/tasks/"+v[M].id,R={method:"POST",headers:x,redirect:"follow",body:JSON.stringify({content:i})};(await fetch(B,R)).ok||alert("Failed to update task in Todoist")}}if(w[0][0].children[D].hasOwnProperty("children"))for(var z=0;z<w[0][0].children[D].children.length;z++){const t=/showTask\?id=([0-9]{9,10})/,e=/{{\[\[TODO\]\]}} (.+) \[Link\]\(.+showTask\?id=[0-9]{9,10}\)/,i=/comment-([0-9]{9,10})/,o=/(.+) \[Link\]\(.+\#comment-[0-9]{9,10}\)/;let n,a,s,r,d;if(i.test(w[0][0].children[D].children[z].string)?a=w[0][0].children[D].children[z].string.match(i)[1].toString():t.test(w[0][0].children[D].children[z].string)&&(n=w[0][0].children[D].children[z].string.match(t)[1]),o.test(w[0][0].children[D].children[z].string)?r=w[0][0].children[D].children[z].string.match(o)[1]:e.test(w[0][0].children[D].children[z].string)?(s=w[0][0].children[D].children[z].string.match(e)[1],s.match("#Priority")&&(r=s.split("#Priority")[0])):r=w[0][0].children[D].children[z].string,null!=r&&null!=r&&(d=r.trim()),null==n&&null==a){let t=w[0][0].children[D].string;var H;if(t.includes("Task?id=")){var j=t.split("Task?id=");j[1]&&(H=j[1].match(/^(\d{9,10})/gm)[0])}else{let t=await(window.roamAlphaAPI.q(`[:find ?u :where [?p :block/string ?u] [?p :block/children ?e] [?e :block/uid "${w[0][0].children[D].children[z].uid}"]]`)?.[0]?.[0].toString());const e=/showTask\?id=([0-9]{9,10})/;e.test(t)&&(H=t.match(e)[1])}if(!d.startsWith("{{pdf:")&&!d.includes("[Email Body]")&&!d.startsWith("![]("))if(d.includes("{{[[TODO]]}}"))await _(d,w[0][0].children[D].children[z].uid,H,w[0][0].children[D].uid);else if(null!=v&&null!=v){for(var F=!1,U=0;U<v.length;U++)d==v[U].description&&(F=!0);if(0==F){var q={method:"POST",headers:x,redirect:"follow",body:JSON.stringify({task_id:H,content:d})};(await fetch("https://api.todoist.com/rest/v2/comments",q)).ok||alert("Failed to add comment to task in Todoist")}}}else if(null!=n){for(M=0;M<v.length;M++)if(n==v[M].id&&d!=v[M].content){var J="https://api.todoist.com/rest/v2/tasks/"+v[M].id,W={method:"POST",headers:x,redirect:"follow",body:JSON.stringify({content:d})};(await fetch(J,W)).ok||alert("Failed to update task in Todoist")}}else if(null!=a)for(var $=0;$<y.length;$++)if(y[$].commentsJSON.length>0)for(var Y=0;Y<y[$].commentsJSON.length;Y++)if(a==y[$].commentsJSON[Y].id&&d!=y[$].commentsJSON[Y].content){var G="https://api.todoist.com/rest/v2/comments/"+a,K={method:"POST",headers:x,redirect:"follow",body:JSON.stringify({content:d})};(await fetch(G,K)).ok||alert("Failed to update comment in Todoist")}}}if(w?.[0]?.[0].hasOwnProperty("children"))for(var X=0;X<w[0][0].children.length;X++)await window.roamAlphaAPI.deleteBlock({block:{uid:w[0][0].children[X].uid}});var V={method:"GET",headers:x,redirect:"follow"};const Q=await fetch(lt,V),Z=await Q.text();var tt;let et=[],it=[],ot=[],nt=[],at=[];for await(tt of(t.settings.set("ttt:tasks",JSON.stringify(JSON.parse(Z))),t.settings.set("ttt:tasks:time",Date.now()),JSON.parse(Z)))tt.hasOwnProperty("parent_id")&&null!=tt.parent_id?it.push({id:tt.id,parent_id:tt.parent_id,order:tt.order,content:tt.content,url:tt.url,priority:tt.priority}):et.push({id:tt.id,uid:"temp"});if(m&&(r||I)){const e=new Date;e.setHours(0,0,0,0);let i=new Date(e.setMinutes(e.getMinutes()+e.getTimezoneOffset())),o=i.getFullYear();L=String(i.getDate()).padStart(2,"0"),g="https://api.todoist.com/sync/v9/completed/get_all?since="+o+"-"+(P=String(i.getMonth()+1).padStart(2,"0"))+"-"+L+"T"+String(i.getHours()).padStart(2,"0")+":"+String(i.getMinutes()).padStart(2,"0")+":00";const n=await fetch(g,V),a=await n.text();if(at=JSON.parse(a),at.items.length>0)for(X=0;X<at.items.length;X++)et.push({id:at.items[X].id,uid:"temp"});t.settings.set("ttt:tasksCompleted",JSON.stringify(JSON.parse(a))),t.settings.set("ttt:tasksCompleted:time",Date.now())}else if(m&&s){if(Array.isArray(s)){let t=s[1].toString();s=t}g="https://api.todoist.com/sync/v9/completed/get_all?project_id="+s;const t=await fetch(g,V),e=await t.text();if(at=JSON.parse(e),at.items.length>0)for(X=0;X<at.items.length;X++)et.push({id:at.items[X].id,uid:"temp"})}if(Object.keys(et).length>0){for(X=0;X<et.length;X++)for await(tt of JSON.parse(Z))if(et[X].id==tt.id){var st="";if(st+="{{[[TODO]]}} ",st+=""+tt.content,1==n){if("4"==tt.priority)var rt="1";else"3"==tt.priority?rt="2":"2"==tt.priority?rt="3":"1"==tt.priority&&(rt="4");st+=" #Priority-"+rt}st+=" [Link]("+tt.url+")";var dt=[];if(1==a&&tt.description&&dt.push({text:tt.description.toString()}),1==k&&tt.comment_count>0){var lt="https://api.todoist.com/rest/v2/comments?task_id="+tt.id;const t=await fetch(lt,V),e=await t.text();let i=await JSON.parse(e);for(var ct="",pt=0;pt<i.length;pt++)ct="",null!=i[pt].attachment&&"Premium"==f?"application/pdf"==i[pt].attachment.file_type?ct="{{pdf: "+i[pt].attachment.file_url+"}}":"image/jpeg"==i[pt].attachment.file_type||"image/png"==i[pt].attachment.file_type?ct="![]("+i[pt].attachment.file_url+")":(ct=""+i[pt].content,ct+=" [Link](https://todoist.com/showTask?id="+i[pt].task_id+"#comment-"+i[pt].id+")"):null!=i[pt].attachment?"text/html"==i[pt].attachment.file_type&&(ct=i[pt].content+" [Email Body]("+i[pt].attachment.file_url+")"):(ct=""+i[pt].content,ct+=" [Link](https://todoist.com/showTask?id="+i[pt].task_id+"#comment-"+i[pt].id+")"),ct.length>0&&dt.push({text:ct.toString(),tID:i[pt].task_id,ID:i[pt].id});nt.push({task:tt.id,commentsJSON:i})}if(1==b&&it.length>0)for(var ut=0;ut<it.length;ut++)if(it[ut].parent_id==tt.id){var mt="";mt+="{{[[TODO]]}} ",mt+=""+it[ut].content,1==n&&("4"==tt.priority?rt="1":"3"==tt.priority?rt="2":"2"==tt.priority?rt="3":"1"==tt.priority&&(rt="4"),mt+=" #Priority-"+it[ut].priority),mt+=" [Link]("+it[ut].url+")",dt.push({text:mt.toString()});var ht=it.indexOf(it[ut]);-1!==ht&&it.splice(ht,1)}dt.length>0?ot.push({text:st.toString(),children:dt}):ot.push({text:st.toString()})}if(null!=it&&it.length>0)for(var gt=0;gt<it.length;gt++)st="",st+="{{[[TODO]]}} ",st+=""+it[gt].content,1==n&&("4"==tt.priority?rt="1":"3"==tt.priority?rt="2":"2"==tt.priority?rt="3":"1"==tt.priority&&(rt="4"),st+=" #Priority-"+it[gt].priority),st+=" [Link]("+it[gt].url+")",ot.push({text:st.toString()});if(m&&at.items.length>0)for(pt=0;pt<at.items.length;pt++)st="{{[[DONE]]}} ",h&&(st+="~~"),st+=at.items[pt].content+" [Link](https://todoist.com/showTask?id="+at.items[pt].task_id+")",h&&(st+="~~"),ot.push({text:st.toString()});if(t.settings.get("ttt:comments")&&t.settings.set("ttt:comments-lastsync",t.settings.get("ttt:comments")),t.settings.set("ttt:comments",JSON.stringify(nt)),t.settings.set("ttt:comments:time",Date.now()),u){var wt=[];return wt.push({text:i.toString(),children:ot}),wt}if(!l)return ot;p=c,ot.forEach((t,e)=>{O({parentUid:p,order:e,node:t})})}else l||alert("No items to import")}window.roamjs?.extension?.smartblocks?window.roamjs.extension.smartblocks.registerCommand(a):document.body.addEventListener("roamjs:smartblocks:loaded",()=>window.roamjs?.extension.smartblocks&&window.roamjs.extension.smartblocks.registerCommand(a)),t.ui.commandPalette.addCommand({label:"Create task in Todoist",callback:()=>_()}),t.ui.commandPalette.addCommand({label:"Link a Todoist project",callback:()=>{(async function(){var e;if(t.settings.get("ttt-token")){const f=t.settings.get("ttt-token");e=t.settings.get("ttt-import-header")?t.settings.get("ttt-import-header"):"Imported tasks",m=t.settings.get("ttt-overdue"),v=t.settings.get("ttt-priority"),y=t.settings.get("ttt-description"),h=t.settings.get("ttt-completed"),I=t.settings.get("ttt-completedStrikethrough");var i=new Headers,o="Bearer "+f;i.append("Authorization",o);var n={method:"GET",headers:i,redirect:"follow"};const k=await fetch("https://api.todoist.com/rest/v2/projects",n);var a=await k.json();let b='<select><option value="">Select</option>';for(var s=0;s<a.length;s++)b+='<option value="'+a[s].id+"~"+a[s].name+'">'+a[s].name+"</option>";b+="</select>";var r=await N(1,b,null);if("cancelled"==r)return await N(2,null,"You cancelled the project linking"),null;{var d="projectID: "+r[0],l=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid();if(!l){const t=/^https:\/\/roamresearch.com\/#\/(app|offline)\/\w+$/;if(window.location.href.match(t)){var c=new Date,p=String(c.getDate()).padStart(2,"0");l=String(c.getMonth()+1).padStart(2,"0")+"-"+p+"-"+c.getFullYear()}}let t=`[:find (pull ?page [:node/title :block/string :block/uid {:block/children ...} ]) :where [?page :block/uid "${l}"]  ]`;var u=await window.roamAlphaAPI.q(t);if(u.length>0){var g=!1;if(u[0][0].hasOwnProperty("children"))for(s=0;s<u[0][0]?.children.length;s++)u[0][0].children[s].string.match("projectID: ")&&(console.log("Updating project id"),await window.roamAlphaAPI.updateBlock({block:{uid:u[0][0].children[s].uid,string:d.toString(),open:!0}}),g=!0);if(0==g){console.log("Creating project_id link");var w=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":u[0][0].uid,order:999},block:{string:"",uid:w}}),w=window.roamAlphaAPI.util.generateUID(),await window.roamAlphaAPI.createBlock({location:{"parent-uid":u[0][0].uid,order:999},block:{string:"---",uid:w}}),w=window.roamAlphaAPI.util.generateUID(),await window.roamAlphaAPI.createBlock({location:{"parent-uid":u[0][0].uid,order:1e4},block:{string:d.toString(),uid:w}})}}return q(f,e,m,v,y,r[0],!1,l,!1,null,null,h,I)}}E("API")})().then(async t=>{if(null!=t){var e=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid();if(null==e){var i=window.location.href;if(/^https:\/\/roamresearch.com\/.+\/(app|offline)\/\w+$/.test(i)){var o=new Date,n=String(o.getDate()).padStart(2,"0");e=String(o.getMonth()+1).padStart(2,"0")+"-"+n+"-"+o.getFullYear()}}var a=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":e,order:0},block:{string:u.toString(),uid:a}}),p=a,t.forEach((t,e)=>O({parentUid:p,order:e,node:t}))}})}}),t.ui.commandPalette.addCommand({label:"Reschedule task(s) in Todoist",callback:()=>j()}),window.roamAlphaAPI.ui.blockContextMenu.addCommand({label:"Reschedule task(s) in Todoist",callback:t=>j(t)}),1==t.settings.get("ttt-auto")&&(S=!0,H()),u=t.settings.get("ttt-import-header")?t.settings.get("ttt-import-header"):"Imported tasks",1==t.settings.get("ttt-advChildFeat")&&(C=!0),B(),s=function(t){if("KeyI"===t.code&&t.shiftKey&&t.altKey)return R()},window.addEventListener("keydown",s,!1)},onunload:()=>{window.roamAlphaAPI.ui.blockContextMenu.removeCommand({label:"Reschedule task(s) in Todoist"}),window.roamjs?.extension?.smartblocks&&window.roamjs.extension.smartblocks.unregisterCommand("IMPORTTODOIST"),r.disconnect(),window.removeEventListener("keydown",s,!1),clearInterval(T)}};function E(t){"API"==t&&alert("Please set your API token in the configuration settings via the Roam Depot tab.")}async function x(t){return new Promise(e=>setTimeout(e,t))}async function N(t,e,i){if(1==t)return new Promise(t=>{var i,o;a().question({theme:"light",color:"black",layout:2,class:"toTaMa",drag:!1,timeout:!1,close:!0,overlay:!0,title:"Todoist Task Management",message:"Select which project to link",position:"center",onClosed:function(){t("cancelled")},closeOnEscape:!0,inputs:[["<label>Project *"+e+"</label>","change",function(t,e,n,a){i=a.target.value.split("~")[0],o=a.target.value.split("~")[1]}]],buttons:[["<button><b>Confirm</b></button>",function(e,n,a,s,r){e.hide({transitionOut:"fadeOut"},n,"button"),t([i,o])},!1],["<button>Cancel</button>",function(e,i,o,n){e.hide({transitionOut:"fadeOut"},i,"button"),t("cancelled")}]]})});2==t&&a().show({theme:"dark",message:i,class:"toTaMa-info",position:"center",close:!1,timeout:3e3,closeOnClick:!0,closeOnEscape:!0,displayMode:2})}const D=o.A;export{D as default};