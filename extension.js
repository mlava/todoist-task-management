var t={568:function(t,e,o){var n,i,a;void 0!==o.g?o.g:window||this.window||this.global,i=[],void 0===(a="function"==typeof(n=function(){var t={},e="iziToast",o=(document.querySelector("body"),!!/Mobi/.test(navigator.userAgent)),n=/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor),i="undefined"!=typeof InstallTrigger,a="ontouchstart"in document.documentElement,s=["bottomRight","bottomLeft","bottomCenter","topRight","topLeft","topCenter","center"],r=568,d={};t.children={};var c={id:null,class:"",title:"",titleColor:"",titleSize:"",titleLineHeight:"",message:"",messageColor:"",messageSize:"",messageLineHeight:"",backgroundColor:"",theme:"light",color:"",icon:"",iconText:"",iconColor:"",iconUrl:null,image:"",imageWidth:50,maxWidth:null,zindex:null,layout:1,balloon:!1,close:!0,closeOnEscape:!1,closeOnClick:!1,displayMode:0,position:"bottomRight",target:"",targetFirst:!0,timeout:5e3,rtl:!1,animateInside:!0,drag:!0,pauseOnHover:!0,resetOnHover:!1,progressBar:!0,progressBarColor:"",progressBarEasing:"linear",overlay:!1,overlayClose:!1,overlayColor:"rgba(0, 0, 0, 0.6)",transitionIn:"fadeInUp",transitionOut:"fadeOut",transitionInMobile:"fadeInUp",transitionOutMobile:"fadeOutDown",buttons:{},inputs:{},onOpening:function(){},onOpened:function(){},onClosing:function(){},onClosed:function(){}};if("remove"in Element.prototype||(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)}),"function"!=typeof window.CustomEvent){var l=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var o=document.createEvent("CustomEvent");return o.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),o};l.prototype=window.Event.prototype,window.CustomEvent=l}var p=function(t,e,o){if("[object Object]"===Object.prototype.toString.call(t))for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.call(o,t[n],n,t);else if(t)for(var i=0,a=t.length;i<a;i++)e.call(o,t[i],i,t)},u=function(t,e){var o={};return p(t,function(e,n){o[n]=t[n]}),p(e,function(t,n){o[n]=e[n]}),o},m=function(t){var e=document.createDocumentFragment(),o=document.createElement("div");for(o.innerHTML=t;o.firstChild;)e.appendChild(o.firstChild);return e},h={move:function(t,o,a,s){var r,d=.3,c=180;0!==s&&(t.classList.add(e+"-dragged"),t.style.transform="translateX("+s+"px)",s>0?(r=(c-s)/c)<d&&o.hide(u(a,{transitionOut:"fadeOutRight",transitionOutMobile:"fadeOutRight"}),t,"drag"):(r=(c+s)/c)<d&&o.hide(u(a,{transitionOut:"fadeOutLeft",transitionOutMobile:"fadeOutLeft"}),t,"drag"),t.style.opacity=r,r<d&&((n||i)&&(t.style.left=s+"px"),t.parentNode.style.opacity=d,this.stopMoving(t,null)))},startMoving:function(t,e,o,n){n=n||window.event;var i=a?n.touches[0].clientX:n.clientX,s=t.style.transform.replace("px)",""),r=i-(s=s.replace("translateX(",""));o.transitionIn&&t.classList.remove(o.transitionIn),o.transitionInMobile&&t.classList.remove(o.transitionInMobile),t.style.transition="",a?document.ontouchmove=function(n){n.preventDefault();var i=(n=n||window.event).touches[0].clientX-r;h.move(t,e,o,i)}:document.onmousemove=function(n){n.preventDefault();var i=(n=n||window.event).clientX-r;h.move(t,e,o,i)}},stopMoving:function(t,o){a?document.ontouchmove=function(){}:document.onmousemove=function(){},t.style.opacity="",t.style.transform="",t.classList.contains(e+"-dragged")&&(t.classList.remove(e+"-dragged"),t.style.transition="transform 0.4s ease, opacity 0.4s ease",setTimeout(function(){t.style.transition=""},400))}};return t.setSetting=function(e,o,n){t.children[e][o]=n},t.getSetting=function(e,o){return t.children[e][o]},t.destroy=function(){p(document.querySelectorAll("."+e+"-overlay"),function(t,e){t.remove()}),p(document.querySelectorAll("."+e+"-wrapper"),function(t,e){t.remove()}),p(document.querySelectorAll("."+e),function(t,e){t.remove()}),this.children={},document.removeEventListener(e+"-opened",{},!1),document.removeEventListener(e+"-opening",{},!1),document.removeEventListener(e+"-closing",{},!1),document.removeEventListener(e+"-closed",{},!1),document.removeEventListener("keyup",{},!1),d={}},t.settings=function(e){t.destroy(),d=e,c=u(c,e||{})},p({info:{color:"blue",icon:"ico-info"},success:{color:"green",icon:"ico-success"},warning:{color:"orange",icon:"ico-warning"},error:{color:"red",icon:"ico-error"},question:{color:"yellow",icon:"ico-question"}},function(e,o){t[o]=function(t){var o=u(d,t||{});o=u(e,o||{}),this.show(o)}}),t.progress=function(t,o,n){var i=this,a=o.getAttribute("data-iziToast-ref"),s=u(this.children[a],t||{}),r=o.querySelector("."+e+"-progressbar div");return{start:function(){void 0===s.time.REMAINING&&(o.classList.remove(e+"-reseted"),null!==r&&(r.style.transition="width "+s.timeout+"ms "+s.progressBarEasing,r.style.width="0%"),s.time.START=(new Date).getTime(),s.time.END=s.time.START+s.timeout,s.time.TIMER=setTimeout(function(){clearTimeout(s.time.TIMER),o.classList.contains(e+"-closing")||(i.hide(s,o,"timeout"),"function"==typeof n&&n.apply(i))},s.timeout),i.setSetting(a,"time",s.time))},pause:function(){if(void 0!==s.time.START&&!o.classList.contains(e+"-paused")&&!o.classList.contains(e+"-reseted")){if(o.classList.add(e+"-paused"),s.time.REMAINING=s.time.END-(new Date).getTime(),clearTimeout(s.time.TIMER),i.setSetting(a,"time",s.time),null!==r){var t=window.getComputedStyle(r).getPropertyValue("width");r.style.transition="none",r.style.width=t}"function"==typeof n&&setTimeout(function(){n.apply(i)},10)}},resume:function(){void 0!==s.time.REMAINING?(o.classList.remove(e+"-paused"),null!==r&&(r.style.transition="width "+s.time.REMAINING+"ms "+s.progressBarEasing,r.style.width="0%"),s.time.END=(new Date).getTime()+s.time.REMAINING,s.time.TIMER=setTimeout(function(){clearTimeout(s.time.TIMER),o.classList.contains(e+"-closing")||(i.hide(s,o,"timeout"),"function"==typeof n&&n.apply(i))},s.time.REMAINING),i.setSetting(a,"time",s.time)):this.start()},reset:function(){clearTimeout(s.time.TIMER),delete s.time.REMAINING,i.setSetting(a,"time",s.time),o.classList.add(e+"-reseted"),o.classList.remove(e+"-paused"),null!==r&&(r.style.transition="none",r.style.width="100%"),"function"==typeof n&&setTimeout(function(){n.apply(i)},10)}}},t.hide=function(t,n,i){"object"!=typeof n&&(n=document.querySelector(n));var a=this,s=u(this.children[n.getAttribute("data-iziToast-ref")],t||{});s.closedBy=i||null,delete s.time.REMAINING,n.classList.add(e+"-closing"),function(){var t=document.querySelector("."+e+"-overlay");if(null!==t){var o=t.getAttribute("data-iziToast-ref"),n=(o=o.split(",")).indexOf(String(s.ref));-1!==n&&o.splice(n,1),t.setAttribute("data-iziToast-ref",o.join()),0===o.length&&(t.classList.remove("fadeIn"),t.classList.add("fadeOut"),setTimeout(function(){t.remove()},700))}}(),s.transitionIn&&n.classList.remove(s.transitionIn),s.transitionInMobile&&n.classList.remove(s.transitionInMobile),o||window.innerWidth<=r?s.transitionOutMobile&&n.classList.add(s.transitionOutMobile):s.transitionOut&&n.classList.add(s.transitionOut);var d=n.parentNode.offsetHeight;n.parentNode.style.height=d+"px",n.style.pointerEvents="none",(!o||window.innerWidth>r)&&(n.parentNode.style.transitionDelay="0.2s");try{var c=new CustomEvent(e+"-closing",{detail:s,bubbles:!0,cancelable:!0});document.dispatchEvent(c)}catch(t){console.warn(t)}setTimeout(function(){n.parentNode.style.height="0px",n.parentNode.style.overflow="",setTimeout(function(){delete a.children[s.ref],n.parentNode.remove();try{var t=new CustomEvent(e+"-closed",{detail:s,bubbles:!0,cancelable:!0});document.dispatchEvent(t)}catch(t){console.warn(t)}void 0!==s.onClosed&&s.onClosed.apply(null,[s,n,i])},1e3)},200),void 0!==s.onClosing&&s.onClosing.apply(null,[s,n,i])},t.show=function(n){var i,l=this,g=u(d,n||{});if((g=u(c,g)).time={},null===g.id&&(g.id=(i=g.title+g.message+g.color,btoa(encodeURIComponent(i)).replace(/=/g,""))),1===g.displayMode||"once"==g.displayMode)try{if(document.querySelectorAll("."+e+"#"+g.id).length>0)return!1}catch(t){console.warn("["+e+"] Could not find an element with this selector: #"+g.id+". Try to set an valid id.")}if(2===g.displayMode||"replace"==g.displayMode)try{p(document.querySelectorAll("."+e+"#"+g.id),function(t,e){l.hide(g,t,"replaced")})}catch(t){console.warn("["+e+"] Could not find an element with this selector: #"+g.id+". Try to set an valid id.")}g.ref=(new Date).getTime()+Math.floor(1e7*Math.random()+1),t.children[g.ref]=g;var w,f={body:document.querySelector("body"),overlay:document.createElement("div"),toast:document.createElement("div"),toastBody:document.createElement("div"),toastTexts:document.createElement("div"),toastCapsule:document.createElement("div"),cover:document.createElement("div"),buttons:document.createElement("div"),inputs:document.createElement("div"),icon:g.iconUrl?document.createElement("img"):document.createElement("i"),wrapper:null};f.toast.setAttribute("data-iziToast-ref",g.ref),f.toast.appendChild(f.toastBody),f.toastCapsule.appendChild(f.toast),function(){if(f.toast.classList.add(e),f.toast.classList.add(e+"-opening"),f.toastCapsule.classList.add(e+"-capsule"),f.toastBody.classList.add(e+"-body"),f.toastTexts.classList.add(e+"-texts"),o||window.innerWidth<=r?g.transitionInMobile&&f.toast.classList.add(g.transitionInMobile):g.transitionIn&&f.toast.classList.add(g.transitionIn),g.class){var t=g.class.split(" ");p(t,function(t,e){f.toast.classList.add(t)})}var n;g.id&&(f.toast.id=g.id),g.rtl&&(f.toast.classList.add(e+"-rtl"),f.toast.setAttribute("dir","rtl")),g.layout>1&&f.toast.classList.add(e+"-layout"+g.layout),g.balloon&&f.toast.classList.add(e+"-balloon"),g.maxWidth&&(isNaN(g.maxWidth)?f.toast.style.maxWidth=g.maxWidth:f.toast.style.maxWidth=g.maxWidth+"px"),""===g.theme&&"light"===g.theme||f.toast.classList.add(e+"-theme-"+g.theme),g.color&&("#"==(n=g.color).substring(0,1)||"rgb"==n.substring(0,3)||"hsl"==n.substring(0,3)?f.toast.style.background=g.color:f.toast.classList.add(e+"-color-"+g.color)),g.backgroundColor&&(f.toast.style.background=g.backgroundColor,g.balloon&&(f.toast.style.borderColor=g.backgroundColor))}(),g.image&&(f.cover.classList.add(e+"-cover"),f.cover.style.width=g.imageWidth+"px",function(t){try{return btoa(atob(t))==t}catch(t){return!1}}(g.image.replace(/ /g,""))?f.cover.style.backgroundImage="url(data:image/png;base64,"+g.image.replace(/ /g,"")+")":f.cover.style.backgroundImage="url("+g.image+")",g.rtl?f.toastBody.style.marginRight=g.imageWidth+10+"px":f.toastBody.style.marginLeft=g.imageWidth+10+"px",f.toast.appendChild(f.cover)),g.close?(f.buttonClose=document.createElement("button"),f.buttonClose.type="button",f.buttonClose.classList.add(e+"-close"),f.buttonClose.addEventListener("click",function(t){t.target,l.hide(g,f.toast,"button")}),f.toast.appendChild(f.buttonClose)):g.rtl?f.toast.style.paddingLeft="18px":f.toast.style.paddingRight="18px",g.progressBar&&(f.progressBar=document.createElement("div"),f.progressBarDiv=document.createElement("div"),f.progressBar.classList.add(e+"-progressbar"),f.progressBarDiv.style.background=g.progressBarColor,f.progressBar.appendChild(f.progressBarDiv),f.toast.appendChild(f.progressBar)),g.timeout&&(g.pauseOnHover&&!g.resetOnHover&&(f.toast.addEventListener("mouseenter",function(t){l.progress(g,f.toast).pause()}),f.toast.addEventListener("mouseleave",function(t){l.progress(g,f.toast).resume()})),g.resetOnHover&&(f.toast.addEventListener("mouseenter",function(t){l.progress(g,f.toast).reset()}),f.toast.addEventListener("mouseleave",function(t){l.progress(g,f.toast).start()}))),g.iconUrl?(f.icon.setAttribute("class",e+"-icon"),f.icon.setAttribute("src",g.iconUrl)):g.icon&&(f.icon.setAttribute("class",e+"-icon "+g.icon),g.iconText&&f.icon.appendChild(document.createTextNode(g.iconText)),g.iconColor&&(f.icon.style.color=g.iconColor)),(g.icon||g.iconUrl)&&(g.rtl?f.toastBody.style.paddingRight="33px":f.toastBody.style.paddingLeft="33px",f.toastBody.appendChild(f.icon)),g.title.length>0&&(f.strong=document.createElement("strong"),f.strong.classList.add(e+"-title"),f.strong.appendChild(m(g.title)),f.toastTexts.appendChild(f.strong),g.titleColor&&(f.strong.style.color=g.titleColor),g.titleSize&&(isNaN(g.titleSize)?f.strong.style.fontSize=g.titleSize:f.strong.style.fontSize=g.titleSize+"px"),g.titleLineHeight&&(isNaN(g.titleSize)?f.strong.style.lineHeight=g.titleLineHeight:f.strong.style.lineHeight=g.titleLineHeight+"px")),g.message.length>0&&(f.p=document.createElement("p"),f.p.classList.add(e+"-message"),f.p.appendChild(m(g.message)),f.toastTexts.appendChild(f.p),g.messageColor&&(f.p.style.color=g.messageColor),g.messageSize&&(isNaN(g.titleSize)?f.p.style.fontSize=g.messageSize:f.p.style.fontSize=g.messageSize+"px"),g.messageLineHeight&&(isNaN(g.titleSize)?f.p.style.lineHeight=g.messageLineHeight:f.p.style.lineHeight=g.messageLineHeight+"px")),g.title.length>0&&g.message.length>0&&(g.rtl?f.strong.style.marginLeft="10px":2===g.layout||g.rtl||(f.strong.style.marginRight="10px")),f.toastBody.appendChild(f.toastTexts),g.inputs.length>0&&(f.inputs.classList.add(e+"-inputs"),p(g.inputs,function(t,o){f.inputs.appendChild(m(t[0])),(w=f.inputs.childNodes)[o].classList.add(e+"-inputs-child"),t[3]&&setTimeout(function(){w[o].focus()},300),w[o].addEventListener(t[1],function(e){return(0,t[2])(l,f.toast,this,e)})}),f.toastBody.appendChild(f.inputs)),g.buttons.length>0&&(f.buttons.classList.add(e+"-buttons"),p(g.buttons,function(t,o){f.buttons.appendChild(m(t[0]));var n=f.buttons.childNodes;n[o].classList.add(e+"-buttons-child"),t[2]&&setTimeout(function(){n[o].focus()},300),n[o].addEventListener("click",function(e){return e.preventDefault(),(0,t[1])(l,f.toast,this,e,w)})})),f.toastBody.appendChild(f.buttons),g.message.length>0&&(g.inputs.length>0||g.buttons.length>0)&&(f.p.style.marginBottom="0"),(g.inputs.length>0||g.buttons.length>0)&&(g.rtl?f.toastTexts.style.marginLeft="10px":f.toastTexts.style.marginRight="10px",g.inputs.length>0&&g.buttons.length>0&&(g.rtl?f.inputs.style.marginLeft="8px":f.inputs.style.marginRight="8px")),f.toastCapsule.style.visibility="hidden",setTimeout(function(){var t=f.toast.offsetHeight,e=f.toast.currentStyle||window.getComputedStyle(f.toast),o=e.marginTop;o=o.split("px"),o=parseInt(o[0]);var n=e.marginBottom;n=n.split("px"),n=parseInt(n[0]),f.toastCapsule.style.visibility="",f.toastCapsule.style.height=t+n+o+"px",setTimeout(function(){f.toastCapsule.style.height="auto",g.target&&(f.toastCapsule.style.overflow="visible")},500),g.timeout&&l.progress(g,f.toast).start()},100),function(){var t=g.position;if(g.target)f.wrapper=document.querySelector(g.target),f.wrapper.classList.add(e+"-target"),g.targetFirst?f.wrapper.insertBefore(f.toastCapsule,f.wrapper.firstChild):f.wrapper.appendChild(f.toastCapsule);else{if(-1==s.indexOf(g.position))return void console.warn("["+e+"] Incorrect position.\nIt can be â€º "+s);t=o||window.innerWidth<=r?"bottomLeft"==g.position||"bottomRight"==g.position||"bottomCenter"==g.position?e+"-wrapper-bottomCenter":"topLeft"==g.position||"topRight"==g.position||"topCenter"==g.position?e+"-wrapper-topCenter":e+"-wrapper-center":e+"-wrapper-"+t,f.wrapper=document.querySelector("."+e+"-wrapper."+t),f.wrapper||(f.wrapper=document.createElement("div"),f.wrapper.classList.add(e+"-wrapper"),f.wrapper.classList.add(t),document.body.appendChild(f.wrapper)),"topLeft"==g.position||"topCenter"==g.position||"topRight"==g.position?f.wrapper.insertBefore(f.toastCapsule,f.wrapper.firstChild):f.wrapper.appendChild(f.toastCapsule)}isNaN(g.zindex)?console.warn("["+e+"] Invalid zIndex."):f.wrapper.style.zIndex=g.zindex}(),g.overlay&&(null!==document.querySelector("."+e+"-overlay.fadeIn")?(f.overlay=document.querySelector("."+e+"-overlay"),f.overlay.setAttribute("data-iziToast-ref",f.overlay.getAttribute("data-iziToast-ref")+","+g.ref),isNaN(g.zindex)||null===g.zindex||(f.overlay.style.zIndex=g.zindex-1)):(f.overlay.classList.add(e+"-overlay"),f.overlay.classList.add("fadeIn"),f.overlay.style.background=g.overlayColor,f.overlay.setAttribute("data-iziToast-ref",g.ref),isNaN(g.zindex)||null===g.zindex||(f.overlay.style.zIndex=g.zindex-1),document.querySelector("body").appendChild(f.overlay)),g.overlayClose?(f.overlay.removeEventListener("click",{}),f.overlay.addEventListener("click",function(t){l.hide(g,f.toast,"overlay")})):f.overlay.removeEventListener("click",{})),function(){if(g.animateInside){f.toast.classList.add(e+"-animateInside");var t=[200,100,300];"bounceInLeft"!=g.transitionIn&&"bounceInRight"!=g.transitionIn||(t=[400,200,400]),g.title.length>0&&setTimeout(function(){f.strong.classList.add("slideIn")},t[0]),g.message.length>0&&setTimeout(function(){f.p.classList.add("slideIn")},t[1]),(g.icon||g.iconUrl)&&setTimeout(function(){f.icon.classList.add("revealIn")},t[2]);var o=150;g.buttons.length>0&&f.buttons&&setTimeout(function(){p(f.buttons.childNodes,function(t,e){setTimeout(function(){t.classList.add("revealIn")},o),o+=150})},g.inputs.length>0?150:0),g.inputs.length>0&&f.inputs&&(o=150,p(f.inputs.childNodes,function(t,e){setTimeout(function(){t.classList.add("revealIn")},o),o+=150}))}}(),g.onOpening.apply(null,[g,f.toast]);try{var y=new CustomEvent(e+"-opening",{detail:g,bubbles:!0,cancelable:!0});document.dispatchEvent(y)}catch(t){console.warn(t)}setTimeout(function(){f.toast.classList.remove(e+"-opening"),f.toast.classList.add(e+"-opened");try{var t=new CustomEvent(e+"-opened",{detail:g,bubbles:!0,cancelable:!0});document.dispatchEvent(t)}catch(t){console.warn(t)}g.onOpened.apply(null,[g,f.toast])},1e3),g.drag&&(a?(f.toast.addEventListener("touchstart",function(t){h.startMoving(this,l,g,t)},!1),f.toast.addEventListener("touchend",function(t){h.stopMoving(this,t)},!1)):(f.toast.addEventListener("mousedown",function(t){t.preventDefault(),h.startMoving(this,l,g,t)},!1),f.toast.addEventListener("mouseup",function(t){t.preventDefault(),h.stopMoving(this,t)},!1))),g.closeOnEscape&&document.addEventListener("keyup",function(t){27==(t=t||window.event).keyCode&&l.hide(g,f.toast,"esc")}),g.closeOnClick&&f.toast.addEventListener("click",function(t){l.hide(g,f.toast,"toast")}),l.toast=f.toast},t}())?n.apply(e,i):n)||(t.exports=a)}},e={};function o(n){var i=e[n];if(void 0!==i)return i.exports;var a=e[n]={exports:{}};return t[n].call(a.exports,a,a.exports,o),a.exports}o.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return o.d(e,{a:e}),e},o.d=(t,e)=>{for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var n={};o.d(n,{A:()=>L});var i=o(568),a=o.n(i);let s;var r,d,c,l=void 0;let p;var u,m,h,g,w,f,y,v,k,b=0,I=15,A=!1,T=!1;const C=t=>{const e=window.roamAlphaAPI.util.generateUID();return Promise.all([window.roamAlphaAPI.createBlock({location:{"parent-uid":t.parentUid,order:t.order},block:{uid:e,string:t.node.text}})].concat((t.node.children||[]).map((t,o)=>C({parentUid:e,order:o,node:t}))))},S=({onSubmit:t,title:e,onClose:o})=>{var n=new Date;const[i,a]=window.React.useState(n),s=window.React.useCallback(e=>{t(e),o()},[a,o]),r=window.React.useCallback(()=>{t(""),o()},[o]);return window.React.createElement(window.Blueprint.Core.Dialog,{isOpen:!0,enforceFocus:!1,onClose:r,title:e},window.React.createElement("div",{className:window.Blueprint.Core.Classes.DIALOG_BODY},window.React.createElement(window.Blueprint.Core.Label,{},window.React.createElement(window.Blueprint.DateTime.DatePicker,{onChange:s,highlightCurrentDay:!0,popoverProps:{minimal:!0,captureDismiss:!0}}))))},L={onload:({extensionAPI:t})=>{const e={tabTitle:"Todoist Task Management",settings:[{id:"ttt-token",name:"Todoist API Token",description:"Your API token from https://todoist.com/app/settings/integrations",action:{type:"input",placeholder:"Add Todoist API token here"}},{id:"ttt-import-header",name:"Roam Research Header",description:"Text Header for Roam Research on import",action:{type:"input",placeholder:"Imported Tasks"}},{id:"ttt-account",name:"Account type",description:"Account type - turn on if subscribed to Todoist Premium",action:{type:"switch"}},{id:"ttt-overdue",name:"Include Overdue",description:"Include tasks that are overdue in Today's tasks",action:{type:"switch"}},{id:"ttt-intermediate",name:"Show Intermediate options",description:"Show more configuration options",action:{type:"switch",onChange:t=>{D(t,1)}}},{id:"ttt-advanced",name:"Show Advanced options (beta)",description:"Show advanced configuration options",action:{type:"switch",onChange:t=>{D(t,2)}}}]},o={tabTitle:"Todoist Task Management",settings:[{id:"ttt-token",name:"Todoist API Token",description:"Your API token from https://todoist.com/app/settings/integrations",action:{type:"input",placeholder:"Add Todoist API token here"}},{id:"ttt-import-header",name:"Roam Research Header",description:"Text Header for Roam Research on import",action:{type:"input",placeholder:"Imported Tasks"}},{id:"ttt-account",name:"Account type",description:"Account type - turn on if subscribed to Todoist Premium",action:{type:"switch"}},{id:"ttt-overdue",name:"Include Overdue",description:"Include tasks that are overdue in Today's tasks",action:{type:"switch"}},{id:"ttt-intermediate",name:"Show Intermediate options",description:"Show more configuration options",action:{type:"switch",onChange:t=>{D(t,1)}}},{id:"ttt-auto",name:"Automatic Download",description:"Import items to the DNP automatically",action:{type:"switch",onChange:t=>{L(t,1)}}},{id:"ttt-auto-time",name:"Automatic Download interval",description:"Frequency in minutes to check for new items",action:{type:"input",placeholder:"15",onChange:t=>{L(t,2)}}},{id:"ttt-completed",name:"Include Completed",description:"Include completed tasks in Today's tasks",action:{type:"switch"}},{id:"ttt-completedStrikethrough",name:"Strikethrough Completed Tasks",description:"Strikethrough task content upon completion",action:{type:"switch"}},{id:"ttt-description",name:"Description",description:"Import item description",action:{type:"switch"}},{id:"ttt-subtasks",name:"Subtasks",description:"Import item subtasks",action:{type:"switch"}},{id:"ttt-comments",name:"Comments",description:"Import item comments",action:{type:"switch"}},{id:"ttt-priority",name:"Priority",description:"Import item priority",action:{type:"switch"}},{id:"ttt-createLink",name:"Link in Created Task",description:"Create a link to the Roam block in newly created Todoist tasks",action:{type:"switch"}},{id:"ttt-advanced",name:"Show Advanced options (beta)",description:"Show advanced configuration options",action:{type:"switch",onChange:t=>{D(t,2)}}}]},n={tabTitle:"Todoist Task Management",settings:[{id:"ttt-token",name:"Todoist API Token",description:"Your API token from https://todoist.com/app/settings/integrations",action:{type:"input",placeholder:"Add Todoist API token here"}},{id:"ttt-import-header",name:"Roam Research Header",description:"Text Header for Roam Research on import",action:{type:"input",placeholder:"Imported Tasks"}},{id:"ttt-account",name:"Account type",description:"Account type - turn on if subscribed to Todoist Premium",action:{type:"switch"}},{id:"ttt-overdue",name:"Include Overdue",description:"Include tasks that are overdue in Today's tasks",action:{type:"switch"}},{id:"ttt-intermediate",name:"Show Intermediate options",description:"Show more configuration options",action:{type:"switch",onChange:t=>{D(t,1)}}},{id:"ttt-auto",name:"Automatic Download",description:"Import items to the DNP automatically",action:{type:"switch",onChange:t=>{L(t,1)}}},{id:"ttt-auto-time",name:"Automatic Download interval",description:"Frequency in minutes to check for new items",action:{type:"input",placeholder:"15",onChange:t=>{L(t,2)}}},{id:"ttt-completed",name:"Include Completed",description:"Include completed tasks in Today's tasks",action:{type:"switch"}},{id:"ttt-completedStrikethrough",name:"Strikethrough Completed Tasks",description:"Strikethrough task content upon completion",action:{type:"switch"}},{id:"ttt-description",name:"Description",description:"Import item description",action:{type:"switch"}},{id:"ttt-subtasks",name:"Subtasks",description:"Import item subtasks",action:{type:"switch"}},{id:"ttt-comments",name:"Comments",description:"Import item comments",action:{type:"switch"}},{id:"ttt-priority",name:"Priority",description:"Import item priority",action:{type:"switch"}},{id:"ttt-createLink",name:"Link in Created Task",description:"Create a link to the Roam block in newly created Todoist tasks",action:{type:"switch"}},{id:"ttt-advanced",name:"Show Advanced options (beta)",description:"Show advanced configuration options",action:{type:"switch",onChange:t=>{D(t,2)}}},{id:"ttt-advChildFeat",name:"Advanced Sync features (beta)",description:"Turn on to automatically create tasks, subtasks and comments from within Roam Research",action:{type:"switch",onChange:t=>{P(t)}}}]},i={tabTitle:"Todoist Task Management",settings:[{id:"ttt-token",name:"Todoist API Token",description:"Your API token from https://todoist.com/app/settings/integrations",action:{type:"input",placeholder:"Add Todoist API token here"}},{id:"ttt-import-header",name:"Roam Research Header",description:"Text Header for Roam Research on import",action:{type:"input",placeholder:"Imported Tasks"}},{id:"ttt-account",name:"Account type",description:"Account type - turn on if subscribed to Todoist Premium",action:{type:"switch"}},{id:"ttt-overdue",name:"Include Overdue",description:"Include tasks that are overdue in Today's tasks",action:{type:"switch"}},{id:"ttt-intermediate",name:"Show Intermediate options",description:"Show more configuration options",action:{type:"switch",onChange:t=>{D(t,1)}}},{id:"ttt-advanced",name:"Show Advanced options (beta)",description:"Show advanced configuration options",action:{type:"switch",onChange:t=>{D(t,2)}}},{id:"ttt-advChildFeat",name:"Advanced Sync features (beta)",description:"Turn on to automatically create tasks, subtasks and comments from within Roam Research",action:{type:"switch",onChange:t=>{P(t)}}}]};t.settings.get("ttt-intermediate")?t.settings.get("ttt-advanced")?t.settings.panel.create(n):t.settings.panel.create(o):t.settings.get("ttt-advanced")?t.settings.panel.create(i):t.settings.panel.create(e),t.ui.commandPalette.addCommand({label:"Import tasks from Todoist",callback:()=>{const t=window.roamAlphaAPI.ui.getFocusedBlock()?.["block-uid"];N(!1,!1).then(async e=>{if(null==t){if(p=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid(),null==p){var o=window.location.href;if(/^https:\/\/roamresearch.com\/.+\/(app|offline)\/\w+$/.test(o)){var n=new Date,i=String(n.getDate()).padStart(2,"0"),a=String(n.getMonth()+1).padStart(2,"0"),s=n.getFullYear();p=a+"-"+i+"-"+s}}var r=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":p,order:0},block:{string:u.toString(),uid:r}}),p=r,e.forEach((t,e)=>C({parentUid:p,order:e,node:t}))}else p=t,await window.roamAlphaAPI.updateBlock({block:{uid:p,string:u.toString(),open:!0}}),null!=e&&e.forEach((t,e)=>C({parentUid:p,order:e,node:t}))})}});const a={text:"IMPORTTODOIST",help:"Import tasks from Todoist",handler:t=>R};async function L(t,e){1==e?t.target.checked?(A=!0,B()):(A=!1,clearInterval(b)):2==e&&(""!=t.target.value?(clearInterval(b),I=parseInt(t.target.value),1==A&&B()):clearInterval(b))}async function P(t){t.target.checked}async function D(a,s){1==s?a.target.checked?t.settings.get("ttt-advanced")?t.settings.panel.create(n):t.settings.panel.create(o):t.settings.get("ttt-advanced")?t.settings.panel.create(i):t.settings.panel.create(e):2==s&&(a.target.checked?t.settings.get("ttt-intermediate")?t.settings.panel.create(n):t.settings.panel.create(i):t.settings.get("ttt-intermediate")?t.settings.panel.create(o):t.settings.panel.create(e))}async function M(){d=document.getElementsByClassName("roam-main")[0],c=document.getElementById("right-sidebar"),l={attributes:!1,childList:!0,subtree:!0},(r=new MutationObserver(function(t,e){for(const l of t)if(1==l.addedNodes[0]?.childNodes[0]?.childNodes[0]?.control?.checked){if(l.addedNodes[0]?.innerHTML?.includes("https://app.todoist.com/app/task")){e.disconnect();var o=l.addedNodes[0]?.innerText?.trim();o=o.split(" Link")[0];var n=l.addedNodes[0]?.innerHTML.split('href="'),i=n[1].split('"');n=i[0];var a=l.addedNodes[0]?.innerHTML?.split("task/"),s=/^(\d{9,10})/gm,r=a[1].match(s),d=l.target?.id?.slice(-9);z(r,o,d,n)}}else if(0==l.addedNodes[0]?.childNodes[0]?.childNodes[0]?.control?.checked&&l.addedNodes[0]?.innerHTML?.includes("https://app.todoist.com/app/task")){e.disconnect(),o=l.addedNodes[0]?.innerText?.trim(),o=o.split(" Link")[0],n=l.addedNodes[0]?.innerHTML.split('href="'),i=n[1].split('"'),n=i[0],a=l.addedNodes[0]?.innerHTML?.split("task/"),s=/^(\d{9,10})/gm;var c=a[1].match(s);d=l.target?.id.slice(-9),j(c,o,d,n)}})).observe(d,l),r.observe(c,l)}async function N(e,o){if(t.settings.get("ttt-token")){const C=t.settings.get("ttt-token");u=t.settings.get("ttt-import-header")?t.settings.get("ttt-import-header"):"Imported tasks",m=t.settings.get("ttt-overdue"),h=t.settings.get("ttt-completed"),w=t.settings.get("ttt-priority"),f=t.settings.get("ttt-description"),y=t.settings.get("ttt-comments"),v=t.settings.get("ttt-subtasks"),t.settings.get("ttt-account");var n,i="projectID: ",a=!1;if(1==e){var s,r=new Date,d=String(r.getDate()).padStart(2,"0"),c=String(r.getMonth()+1).padStart(2,"0"),l=r.getFullYear();g=c+"-"+d+"-"+l;let t=await window.roamAlphaAPI.q(`[:find ?u ?s :where [?b :block/page ?p] [?b :block/uid ?u] [?b :block/order ?s] [?b :block/string "${u}"] [?p :block/uid "${g}"]]`);if(null!=t&&t.length>1){let e,o=999;for(var p=0;p<t.length;p++)parseInt(t[p][1])<o?(o=parseInt(t[p][1]),e&&await window.roamAlphaAPI.deleteBlock({block:{uid:e}}),e=t[p][0].toString()):parseInt(t[p][1])>o&&await window.roamAlphaAPI.deleteBlock({block:{uid:t[p][0]}});s=e}else null!=t&&1==t.length&&(s=t[0][0].toString());if(null==s){const t=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":g,order:9999},block:{string:u,uid:t}}),s=t}n=g}else{var b=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid();if(!b){var I=window.location.href;const t=/^https:\/\/roamresearch.com\/#\/(app|offline)\/\w+$/;document.getElementById("rm-log-container")&&(r=new Date,d=String(r.getDate()).padStart(2,"0"),b=(c=String(r.getMonth()+1).padStart(2,"0"))+"-"+d+"-"+(l=r.getFullYear()),a=!0),t.test(I)&&(r=new Date,d=String(r.getDate()).padStart(2,"0"),b=(c=String(r.getMonth()+1).padStart(2,"0"))+"-"+d+"-"+(l=r.getFullYear()),a=!0)}let t=`[:find (pull ?page [:node/title :block/string :block/uid {:block/children ...} ]) :where [?page :block/uid "${b}"]  ]`;var A=await window.roamAlphaAPI.q(t);if(A.length>0){var T;if(A[0][0].hasOwnProperty("children"))for(p=0;p<A[0][0]?.children.length;p++)A[0][0].children[p].string.match(i)&&(T=A[0][0].children[p].string.split(i));n=A[0][0].uid}}return k=t.settings.get("ttt-completedStrikethrough"),H(C,u,m,w,f,T,a,n,e,s,o,h,k)}O("API")}function R(){return N(!1,!0)}async function B(){console.info("setting automatic download"),/^\d{1,2}$/.test(t.settings.get("ttt-auto-time"))&&(I=parseInt(t.settings.get("ttt-auto-time"))),await N(A);try{b>0&&clearInterval(b)}catch(t){}b=setInterval(async()=>{await N(A)},6e4*I)}async function $(e){var o;r.disconnect();const n=t.settings.get("ttt-token");o=t.settings.get("ttt-import-header")?t.settings.get("ttt-import-header"):"Imported tasks";let i=[],a=await roamAlphaAPI.ui.individualMultiselect.getSelectedUids();if(0===a.length){var s;if(e?(s=e["block-uid"].toString(),c=e["block-string"].toString()):(s=await(window.roamAlphaAPI.ui.getFocusedBlock()?.["block-uid"]),c=await window.roamAlphaAPI.data.pull("[:block/string]",[":block/uid",startBlock])),!c.includes("Task?id="))return void alert("You can't reschedule blocks without a Todoist task");i.push({uid:s,text:c})}else for(var d=0;d<a.length;d++){var c;if((c=(I=await window.roamAlphaAPI.data.pull("[:block/string]",[":block/uid",a[d]]))[":block/string"]).includes("Task?id=")){let t=a[d].toString();i.push({uid:t,text:c})}}if(i.length>0){const t=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid();var l=await(({title:t})=>new Promise(e=>{const o=document.getElementById("app"),n=document.createElement("div");n.id="todoist-prompt-root",o.parentElement.appendChild(n),window.ReactDOM.render(window.React.createElement(S,{onSubmit:e,title:t,onClose:()=>{window.ReactDOM.unmountComponentAtNode(n),n.remove()}}),n)}))({title:"To which date?"});if(l.length<1)return;let e=l.getFullYear();var p=String(l.getDate()).padStart(2,"0"),u=String(l.getMonth()+1).padStart(2,"0");let s=u+"-"+p+"-"+e;var m=function(t){var e=t.split("-"),o=e[2],n=["January","February","March","April","May","June","July","August","September","October","November","December"][Number(e[0])-1],i=Number(e[1]);return n+" "+i+(i>=4&&i<=20||i>=24&&i<=30?"th":["st","nd","rd"][i%10-1])+", "+o}(s),h=await window.roamAlphaAPI.q(`[:find (pull ?e [:node/title]) :where [?e :block/uid "${s}"]]`);h.length>0&&null!=h[0][0]||await window.roamAlphaAPI.createPage({page:{title:m,uid:s}});var g='{"due_date": "'+e+"-"+u+"-"+p+'"}';console.info("Rescheduling task(s) in Todoist");var w=new Headers,f="Bearer "+n;w.append("Authorization",f),w.append("Content-Type","application/json");for(var y={method:"POST",headers:w,body:g},v=0;v<i.length;v++){var k=i[v].text.slice(-11),b="https://api.todoist.com/rest/v2/tasks/"+(k=k.slice(0,10));if((await fetch(b,y)).ok){var I,A=await(window.roamAlphaAPI.q(`[:find ?u :where [?b :block/page ?p] [?b :block/uid ?u] [?b :block/string "${o}"] [?p :block/uid "${s}"]]`)?.[0]?.[0]);if(null==A){const t=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":s,order:0},block:{string:o.toString(),uid:t}}),A=t}if(await window.roamAlphaAPI.moveBlock({location:{"parent-uid":A,order:v},block:{uid:i[v].uid.toString()}}),(I=await window.roamAlphaAPI.q(`[:find (pull ?page [:node/title :block/string :block/uid {:block/children ...} ]) :where [?page :block/uid "${t}"] ]`))[0][0].hasOwnProperty("children")&&I[0][0].children.length>0)for(d=0;d<I[0][0].children.length;d++)if(I[0][0].children[d].string==o){var T=I[0][0]?.children[d]?.uid;I[0][0]?.children[d].hasOwnProperty("children")||await window.roamAlphaAPI.deleteBlock({block:{uid:T}})}}else alert("Failed to reschedule task in Todoist")}0!==a.length&&(window.dispatchEvent(new KeyboardEvent("keydown",{key:"m",keyCode:77,code:"KeyM",which:77,shiftKey:!1,ctrlKey:!0,metaKey:!1})),window.dispatchEvent(new KeyboardEvent("keyup",{key:"m",keyCode:77,code:"KeyM",which:77,shiftKey:!1,ctrlKey:!0,metaKey:!1})))}M()}async function z(e,o,n,i){const a=t.settings.get("ttt-token");k=t.settings.get("ttt-completedStrikethrough");var s=new Headers,r="Bearer "+a;s.append("Authorization",r);var d={method:"POST",headers:s,redirect:"follow"},c="https://api.todoist.com/rest/v2/tasks/"+e+"/close";if((await fetch(c,d)).ok){var l="{{[[DONE]]}} ";k&&(l+="~~"),l+=o.trim()+" [Link]("+i+")",k&&(l+="~~"),await window.roamAlphaAPI.updateBlock({block:{uid:n,string:l.toString(),open:!1}}),console.log("Task Completed in Todoist")}else alert("Failed to complete task in Todoist");await E(50),M()}async function j(e,o,n,i){const a=t.settings.get("ttt-token");var s=new Headers,r="Bearer "+a;s.append("Authorization",r);var d={method:"GET",headers:s,redirect:"follow"},c="https://api.todoist.com/rest/v2/tasks/"+e+"/";const l=await fetch(c,d);var p=await l.text();if(1==JSON.parse(p).due.is_recurring){alert("You can't un-complete a recurring task!");var u="{{[[DONE]]}} ~~"+o.trim()+" [Link]("+i+")~~";await window.roamAlphaAPI.updateBlock({block:{uid:n,string:u.toString(),open:!0}}),await E(50),M()}else{var m={method:"POST",headers:s,redirect:"follow"},h="https://api.todoist.com/rest/v2/tasks/"+e+"/reopen";(await fetch(h,m)).ok?(u="{{[[TODO]]}} "+o.trim(),u+=" [Link]("+i+")",await window.roamAlphaAPI.updateBlock({block:{uid:n,string:u.toString(),open:!0}}),console.log("Task reopened in Todoist")):alert("Failed to reopen task in Todoist"),await E(50),M()}}async function H(e,o,n,i,a,s,r,d,c,l,p,u,m){if(!T){T=!0;try{let h,g,w=!1,f=null;if(/^\d{2}-\d{2}-\d{4}$/.test(d)){const[at,st,rt]=d.split("-");f=`${rt}-${st}-${at}`,w=!0}if(r||c)h=n?"https://api.todoist.com/rest/v2/tasks?filter=Today|Overdue":"https://api.todoist.com/rest/v2/tasks?filter=Today";else if(s)h=Array.isArray(s)?`https://api.todoist.com/rest/v2/tasks?project_id=${s[1]}`:`https://api.todoist.com/rest/v2/tasks?project_id=${s}`;else if(w){const dt=new Date;h=d!==`${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}-${dt.getFullYear()}`?`https://api.todoist.com/rest/v2/tasks?filter=${f}`:n?"https://api.todoist.com/rest/v2/tasks?filter=Today|Overdue":"https://api.todoist.com/rest/v2/tasks?filter=Today"}let k=[];t.settings.get("ttt:tasks")&&(k=JSON.parse(t.settings.get("ttt:tasks")),t.settings.set("ttt:tasks-lastsync",t.settings.get("ttt:tasks")),t.settings.set("ttt:tasks-lastsync:time",Date.now()));let b=[];t.settings.get("ttt:comments")&&(b=JSON.parse(t.settings.get("ttt:comments")),t.settings.set("ttt:comments-lastsync",t.settings.get("ttt:comments")));const I=new Map;if(Array.isArray(k))for(const ct of k)I.set(String(ct.id),{parent_id:ct.parent_id||null,content:ct.content||""});const A=await window.roamAlphaAPI.q(`[:find (pull ?p [:node/title :block/string :block/uid {:block/children ...}]) :where [?p :block/uid "${l}"]]`),S=A?.[0]?.[0]||null,L=/todoist\.com\/(?:app\/task\/|showTask\?id=)([A-Za-z0-9_-]{6,}|\d{9,20})/,O=/#comment-([0-9]{9,10})/,E=new Map,x=new Map,P=new Set,D=new Set;function M(t){return t?t.replace(/{{\[\[(TODO|DONE)\]\]}}\s*/g,"").replace(/~~/g,"").replace(/\s#Priority-\d\b/g,"").replace(/\s\[Link]\([^)]+\)/g,"").trim().toLowerCase():""}function N(t){return t.includes("{{[[DONE]]}}")?"done":t.includes("{{[[TODO]]}}")?"todo":"other"}function R(t){if(!t)return;const e=t.string||"",o=N(e),n="todo"===o||"done"===o;if(n){const t=`${M(e)}|${o}`;t.length>1&&D.add(t)}const i=e.match(L),a=i?i[1]:null;a&&n&&(E.set(a,{uid:t.uid,done:"done"===o}),x.has(a)||x.set(a,t.uid));const s=e.match(O);s&&P.add(s[1]),Array.isArray(t.children)&&t.children.forEach(R)}S?.children&&S.children.forEach(R);const B=new Headers;B.append("Authorization","Bearer "+e),B.append("Content-Type","application/json");const $={method:"GET",headers:B,redirect:"follow"},z=await fetch(h,$),j=await z.json();t.settings.set("ttt:tasks",JSON.stringify(j)),t.settings.set("ttt:tasks:time",Date.now());const H=[],U=new Map;for(const lt of j||[])if(lt?.parent_id){const pt=String(lt.parent_id);U.has(pt)||U.set(pt,[]),U.get(pt).push(lt)}else H.push(lt);let _=[];if(u&&(r||w||s)){function ut(t=new Date){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}function mt(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}T00:00:00`}const ht=ut(),gt=new Date(ht);gt.setDate(gt.getDate()+1);const wt=mt(ht),ft=mt(gt);g=`https://api.todoist.com/api/v1/tasks/completed/by_completion_date?since=${encodeURIComponent(wt)}&until=${encodeURIComponent(ft)}`;const yt=await fetch(g,$),vt=await yt.json();_=vt?.items||[],t.settings.set("ttt:tasksCompleted",JSON.stringify(vt)),t.settings.set("ttt:tasksCompleted:time",Date.now())}const q=t=>(t?.text||"").includes("{{[[DONE]]}}"),F=t=>{const e=t?.text||"";return e.includes("{{[[TODO]]}}")||e.includes("{{[[DONE]]}}")},W=t=>`https://app.todoist.com/app/task/${t}`;function Y(t){const e=String(t.id),o=W(e);let n="{{[[TODO]]}} "+t.content;var a;return i&&t.priority&&(n+=" #Priority-"+("4"==(a=t.priority)?"1":"3"==a?"2":"2"==a?"3":"4")),n+=` [Link](${o})`,{text:n,id:e}}function G(t){const e=String(t.id),o=W(e);let n="{{[[DONE]]}} ";return m&&(n+="~~"),n+=`${t.content} [Link](${o})`,m&&(n+="~~"),{text:n,id:e}}async function K(t){const e=`https://api.todoist.com/rest/v2/comments?task_id=${t}`,o=await fetch(e,$);return o.ok?await o.json():[]}async function J(t){const e=[];if(a&&t.description&&e.push({text:t.description.toString()}),y&&t.comment_count>0){const o=await K(t.id);for(const t of o){if(P.has(String(t.id)))continue;let o=t.content||"";t.attachment&&("application/pdf"===t.attachment.file_type?o=`{{pdf: ${t.attachment.file_url}}}`:"image/jpeg"===t.attachment.file_type||"image/png"===t.attachment.file_type?o=`![](${t.attachment.file_url})`:"text/html"===t.attachment.file_type&&(o=`${t.content} [Email Body](${t.attachment.file_url})`)),o+=` [Link](https://todoist.com/showTask?id=${t.task_id}#comment-${t.id})`,e.push({text:o,tID:t.task_id,ID:t.id})}}return e}async function X({parentUid:t,order:e,node:o}){return C({parentUid:t,order:e,node:o})}function V(t){if(!t?.children||!Array.isArray(t.children)||0===t.children.length)return t;const e=[],o=[];for(const n of t.children)(F(n)?o:e).push(n);const n=o.filter(t=>!q(t)),i=o.filter(t=>q(t));return t.children=[...e,...n,...i],t}const Z=[];let Q=[];for(const kt of H){const bt=String(kt.id),It=`${M(`{{[[TODO]]}} ${kt.content}`)}|todo`;if(E.has(bt)||D.has(It))continue;const{text:At}=Y(kt),Tt={text:At},Ct=await J(kt);if(v&&U.has(bt))for(const St of U.get(bt)){const Lt=String(St.id),Ot=`${M(`{{[[TODO]]}} ${St.content}`)}|todo`;if(E.has(Lt)||D.has(Ot))continue;const{text:Et}=Y(St),xt={text:Et},Pt=await J(St);Pt.length&&(xt.children=Pt),Ct.push(xt)}Ct.length&&(Tt.children=Ct),Z.push(V(Tt))}if(v){const Dt=new Map;for(const[Mt,Nt]of U.entries()){if(!x.has(Mt))continue;const Rt=x.get(Mt),Bt=Nt.filter(t=>{const e=String(t.id),o=`${M(`{{[[TODO]]}} ${t.content}`)}|todo`;return!(E.has(e)||D.has(o))});if(Bt.length){Dt.has(Rt)||Dt.set(Rt,[]);for(const $t of Bt){const{text:zt}=Y($t),jt={text:zt},Ht=await J($t);Ht.length&&(jt.children=Ht),Dt.get(Rt).push({parentUid:Rt,order:999,node:jt})}}}for(const[Ut,_t]of Dt.entries())_t.sort((t,e)=>{const o=q(t.node);return o===q(e.node)?0:o?1:-1}),Q=Q.concat(_t)}if(u&&_.length){const qt=new Map,Ft=[];for(const Wt of _){const{text:Yt,id:Gt}=G(Wt),Kt=`${M(Yt)}|done`;if(E.has(Gt)||D.has(Kt))continue;const Jt=null!=I.get(Gt)?.parent_id?String(I.get(Gt).parent_id):null;if(Jt&&x.has(Jt)){const Xt=x.get(Jt);qt.has(Xt)||qt.set(Xt,[]),qt.get(Xt).push({parentUid:Xt,order:999,node:{text:Yt}})}else{const Vt=Z.find(t=>(t.text||"").includes(`/app/task/${Jt}`)||(t.text||"").includes(`showTask?id=${Jt}`));Jt&&Vt?(Vt.children||(Vt.children=[]),Vt.children.push({text:Yt}),V(Vt)):Ft.push({text:Yt})}}for(const[Zt,Qt]of qt.entries())Qt.sort((t,e)=>{const o=q(t.node);return o===q(e.node)?0:o?1:-1}),Q=Q.concat(Qt);for(const te of Ft)Z.push(te)}const tt=Z.filter(t=>!q(t)),et=Z.filter(t=>q(t)),ot=[...tt,...et];if(t.settings.get("ttt:comments")&&t.settings.set("ttt:comments-lastsync",t.settings.get("ttt:comments")),t.settings.set("ttt:comments:time",Date.now()),p)return[{text:o.toString(),children:ot}];if(!c)return ot;const nt=ot.filter(t=>!q(t)),it=ot.filter(t=>q(t));for(let ee=nt.length-1;ee>=0;ee--){const oe=nt[ee];await C({parentUid:l,order:0,node:oe})}for(let ne=0;ne<it.length;ne++){const ie=it[ne];await C({parentUid:l,order:999999,node:ie})}for(let ae=0;ae<Q.length;ae++){const se=Q[ae];await X(se)}try{const re=await window.roamAlphaAPI.q(`[:find (pull ?p [:block/uid {:block/children [:block/uid :block/string :block/order]}])\n      :where [?p :block/uid "${l}"]]`),de=re?.[0]?.[0];if(de?.children?.length){const ce=de.children.map(t=>({uid:t.uid,text:t.string||""})),le=ce.filter(t=>t.text.includes("{{[[TODO]]}}")),pe=ce.filter(t=>t.text.includes("{{[[DONE]]}}"));if(le.length>0&&pe.length>0){const ue=[...le,...pe];if(ce.map(t=>t.uid).join("|")!==ue.map(t=>t.uid).join("|"))for(let me=0;me<ue.length;me++)await window.roamAlphaAPI.moveBlock({location:{"parent-uid":l,order:me},block:{uid:ue[me].uid}})}}}catch(he){console.error("[Reorder] Failed (moveBlock):",he)}}catch(ge){console.error("importTasks ERROR:",ge)}finally{T=!1}}}window.roamjs?.extension?.smartblocks?window.roamjs.extension.smartblocks.registerCommand(a):document.body.addEventListener("roamjs:smartblocks:loaded",()=>window.roamjs?.extension.smartblocks&&window.roamjs.extension.smartblocks.registerCommand(a)),t.ui.commandPalette.addCommand({label:"Create task in Todoist",callback:()=>async function(e,o,n,i){if(t.settings.get("ttt-token")){const e=t.settings.get("ttt-token"),o=t.settings.get("ttt-createLink");null!=i&&null!=i||(i=await(window.roamAlphaAPI.ui.getFocusedBlock()?.["block-uid"]))||alert("Your cursor must be within a block to create as a task in Todoist");let n=`[:find (pull ?page\n                        [:node/title :block/string :block/uid :children/view-type\n                         :block/order {:block/children ...} {:block/parents ...}\n                        ])\n                     :where [?page :block/uid "${i}"]  ]`;var a,s=await window.roamAlphaAPI.q(n),r="projectID: ";var d;d=/^\{\{\[\[TODO\]\]\}\}.+$/.test(s[0][0].string)?'{"content": "'+s[0][0].string.split("{{[[TODO]]}}")[1]+'"':'{"content": "'+s[0][0].string+'"';const f=/^\d{2}-\d{2}-\d{4}$/;var c=window.location.href;if(f.test(s[0]?.[0]?.parents[0]?.uid)){var l=s[0][0].parents[0].uid.split("-");o&&(d+=', "description": "'+c+"/page/"+i+'"'),d+=', "due_date": "'+l[2]+"-"+l[0]+"-"+l[1]+'"}'}else if(s[0][0].parents[0].hasOwnProperty("children")){o&&(d+=', "description": "'+window.location.href.slice(0,-9)+i+'"');for(var p=0;p<s[0][0].parents[0]?.children.length;p++)s[0][0].parents[0].children[p].string.match(r)&&(a=s[0][0].parents[0].children[p].string.split(r)[1]);d+=null!=a?', "project_id": "'+a+'"}':"}"}var u=new Headers,m="Bearer "+e;u.append("Authorization",m),u.append("Content-Type","application/json");var h={method:"POST",headers:u,body:d};const y=await fetch("https://api.todoist.com/rest/v2/tasks",h),v=await y.text();var g=JSON.parse(v),w="";w+="{{[[TODO]]}} ",w+=""+g.content,w+=" [Link]("+g.url+")",await window.roamAlphaAPI.updateBlock({block:{uid:i,string:w.toString()}})}else O("API")}()}),t.ui.commandPalette.addCommand({label:"Link a Todoist project",callback:()=>{(async function(){var e;if(t.settings.get("ttt-token")){const v=t.settings.get("ttt-token");e=t.settings.get("ttt-import-header")?t.settings.get("ttt-import-header"):"Imported tasks",m=t.settings.get("ttt-overdue"),w=t.settings.get("ttt-priority"),f=t.settings.get("ttt-description"),h=t.settings.get("ttt-completed"),k=t.settings.get("ttt-completedStrikethrough");var o=new Headers,n="Bearer "+v;o.append("Authorization",n);var i={method:"GET",headers:o,redirect:"follow"};const b=await fetch("https://api.todoist.com/rest/v2/projects",i);var a=await b.json();let I='<select><option value="">Select</option>';for(var s=0;s<a.length;s++)I+='<option value="'+a[s].id+"~"+a[s].name+'">'+a[s].name+"</option>";I+="</select>";var r=await x(1,I,null);if("cancelled"==r)return await x(2,null,"You cancelled the project linking"),null;{var d="projectID: "+r[0],c=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid();if(!c){const t=/^https:\/\/roamresearch.com\/#\/(app|offline)\/\w+$/;if(window.location.href.match(t)){var l=new Date,p=String(l.getDate()).padStart(2,"0");c=String(l.getMonth()+1).padStart(2,"0")+"-"+p+"-"+l.getFullYear()}}let t=`[:find (pull ?page [:node/title :block/string :block/uid {:block/children ...} ]) :where [?page :block/uid "${c}"]  ]`;var u=await window.roamAlphaAPI.q(t);if(u.length>0){var g=!1;if(u[0][0].hasOwnProperty("children"))for(s=0;s<u[0][0]?.children.length;s++)u[0][0].children[s].string.match("projectID: ")&&(console.log("Updating project id"),await window.roamAlphaAPI.updateBlock({block:{uid:u[0][0].children[s].uid,string:d.toString(),open:!0}}),g=!0);if(0==g){console.log("Creating project_id link");var y=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":u[0][0].uid,order:999},block:{string:"",uid:y}}),y=window.roamAlphaAPI.util.generateUID(),await window.roamAlphaAPI.createBlock({location:{"parent-uid":u[0][0].uid,order:999},block:{string:"---",uid:y}}),y=window.roamAlphaAPI.util.generateUID(),await window.roamAlphaAPI.createBlock({location:{"parent-uid":u[0][0].uid,order:1e4},block:{string:d.toString(),uid:y}})}}return H(v,e,m,w,f,r[0],!1,c,!1,null,null,h,k)}}O("API")})().then(async t=>{if(null!=t){var e=await window.roamAlphaAPI.ui.mainWindow.getOpenPageOrBlockUid();if(null==e){var o=window.location.href;if(/^https:\/\/roamresearch.com\/.+\/(app|offline)\/\w+$/.test(o)){var n=new Date,i=String(n.getDate()).padStart(2,"0");e=String(n.getMonth()+1).padStart(2,"0")+"-"+i+"-"+n.getFullYear()}}var a=window.roamAlphaAPI.util.generateUID();await window.roamAlphaAPI.createBlock({location:{"parent-uid":e,order:0},block:{string:u.toString(),uid:a}}),p=a,t.forEach((t,e)=>C({parentUid:p,order:e,node:t}))}})}}),t.ui.commandPalette.addCommand({label:"Reschedule task(s) in Todoist",callback:()=>$()}),window.roamAlphaAPI.ui.blockContextMenu.addCommand({label:"Reschedule task(s) in Todoist",callback:t=>$(t)}),1==t.settings.get("ttt-auto")&&(A=!0,B()),u=t.settings.get("ttt-import-header")?t.settings.get("ttt-import-header"):"Imported tasks",t.settings.get("ttt-advChildFeat"),M(),s=function(t){if("KeyI"===t.code&&t.shiftKey&&t.altKey)return N()},window.addEventListener("keydown",s,!1)},onunload:()=>{window.roamAlphaAPI.ui.blockContextMenu.removeCommand({label:"Reschedule task(s) in Todoist"}),window.roamjs?.extension?.smartblocks&&window.roamjs.extension.smartblocks.unregisterCommand("IMPORTTODOIST"),r.disconnect(),window.removeEventListener("keydown",s,!1),clearInterval(b)}};function O(t){"API"==t&&alert("Please set your API token in the configuration settings via the Roam Depot tab.")}async function E(t){return new Promise(e=>setTimeout(e,t))}async function x(t,e,o){if(1==t)return new Promise(t=>{var o,n;a().question({theme:"light",color:"black",layout:2,class:"toTaMa",drag:!1,timeout:!1,close:!0,overlay:!0,title:"Todoist Task Management",message:"Select which project to link",position:"center",onClosed:function(){t("cancelled")},closeOnEscape:!0,inputs:[["<label>Project *"+e+"</label>","change",function(t,e,i,a){o=a.target.value.split("~")[0],n=a.target.value.split("~")[1]}]],buttons:[["<button><b>Confirm</b></button>",function(e,i,a,s,r){e.hide({transitionOut:"fadeOut"},i,"button"),t([o,n])},!1],["<button>Cancel</button>",function(e,o,n,i){e.hide({transitionOut:"fadeOut"},o,"button"),t("cancelled")}]]})});2==t&&a().show({theme:"dark",message:o,class:"toTaMa-info",position:"center",close:!1,timeout:3e3,closeOnClick:!0,closeOnEscape:!0,displayMode:2})}const P=n.A;export{P as default};